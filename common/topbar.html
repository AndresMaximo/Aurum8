<!-- /common/topbar.html -->
<nav class="topbar" id="aurum-topbar">
  <a class="brand" href="/index.html">AURUM∞</a>

  <button class="burger" aria-label="Abrir menú" aria-expanded="false">
    <span></span><span></span><span></span>
  </button>

  <ul class="menu" id="main-menu">
    <li><a href="/index.html">Inicio</a></li>
    <li><a href="/vision.html">Visión</a></li>
    <li><a href="/modulos.html">Módulos</a></li>

    <li class="divider"></li>
    <li><a href="/modulos/ot/index.html">Órdenes de Trabajo</a></li>
    <li><a href="/modulos/recursos-humanos/index.html">Recursos Humanos</a></li>
    <li><a href="/modulos/bodega/index.html">Bodega</a></li>
    <li id="link-admin" style="display:none">
      <a href="/modulos/admin/index.html">Admin Usuarios</a>
    </li>

    <li class="divider"></li>
    <li><a href="/contacto.html">Contacto</a></li>

    <!-- derecha -->
    <li class="right">
      <span id="user-pill" class="pill" style="display:none">—</span>
      <a id="auth-link" href="/login.html">Login</a>
    </li>
  </ul>
</nav>

<style>
  /* barra fija y por encima de todo */
  .topbar{
    position:sticky; top:0; z-index:1000;
    display:flex; align-items:center; gap:14px;
    padding:10px 16px; background:#020607; border-bottom:1px solid #13312b;
  }
  .brand{color:#00f5d4;text-decoration:none;font-weight:800;letter-spacing:.5px}
  .menu{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:10px;align-items:center;width:100%}
  .menu a{display:block;padding:8px 10px;border-radius:10px;text-decoration:none;color:#b7efe4;border:1px solid transparent;white-space:nowrap}
  .menu a:hover{border-color:#1f4a42;background:#081513}
  .menu .right{margin-left:auto;display:flex;align-items:center;gap:10px}
  .menu .divider{width:1px;height:22px;background:#173730;opacity:.5}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #1f4a42;background:#061312;color:#9eeadf;font-size:.86rem}

  .burger{display:none;margin-left:auto;border:0;background:transparent;width:36px;height:32px;cursor:pointer}
  .burger span{display:block;height:2px;background:#b7efe4;margin:6px 4px}

  @media (max-width:820px){
    .burger{display:block}
    .menu{display:none;flex-direction:column;align-items:stretch}
    .menu.show{display:flex}
    .menu .right{margin-left:0}
    .menu .divider{display:none}
  }
</style>

<script type="module">
  import { supabase } from '/js/supabaseClient.js';

  const nav = document.getElementById('aurum-topbar');
  const burger = nav.querySelector('.burger');
  const menu = document.getElementById('main-menu');
  const linkAdmin = nav.querySelector('#link-admin');
  const authLink  = nav.querySelector('#auth-link');
  const userPill  = nav.querySelector('#user-pill');

  // Menú móvil
  burger.addEventListener('click', () => {
    const open = menu.classList.toggle('show');
    burger.setAttribute('aria-expanded', open ? 'true' : 'false');
  });

  // Pinta UI según sesión y rol
  async function refreshAuthUI(){
    const { data } = await supabase.auth.getUser();
    const user = data?.user;
    if (!user){
      authLink.textContent = 'Login';
      authLink.href = '/login.html';
      userPill.style.display = 'none';
      linkAdmin.style.display = 'none';
      return;
    }

    const { data: perfil } = await supabase
      .from('perfiles')
      .select('role, full_name, email')
      .eq('id', user.id)
      .maybeSingle();

    const rol = perfil?.role || 'viewer';
    const nombre = perfil?.full_name || perfil?.email || user.email;

    userPill.textContent = `${nombre} · ${rol}`;
    userPill.style.display = 'inline-block';

    authLink.textContent = 'Salir';
    authLink.href = '#';

    linkAdmin.style.display = (rol === 'admin') ? 'list-item' : 'none';
  }
  await refreshAuthUI();

  // Logout
  authLink.addEventListener('click', async (e)=>{
    if (authLink.textContent === 'Salir'){
      e.preventDefault();
      await supabase.auth.signOut();
      location.href = '/login.html';
    }
  });

  // Cambios de sesión
  supabase.auth.onAuthStateChange(() => refreshAuthUI());
</script>