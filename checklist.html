<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checklist T√©cnico 3D ¬∑ AURUM‚àû</title>

  <!-- Estilos base + tema Lemuriano -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="lemuria.css" />

  <!-- Visor 3D -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    /* Layout */
    main{max-width:1200px;margin:20px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    /* Tarjetas */
    .card{background:var(--bg-card);border:1px solid var(--gold-20);
      border-radius:14px;padding:18px 16px;box-shadow:var(--shadow)}

    /* Visor */
    model-viewer{width:100%;height:62vh;border-radius:12px;background:#0f0f14}
    .mv-controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .btn{background:linear-gradient(90deg,#b8860b,#ffd700);border:none;
      color:#0d0d0d;font-weight:700;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.alt{background:#152026;color:#ddd;border:1px solid var(--gold-20)}
    .btn.small{padding:6px 10px}

    /* Hotspots */
    .hotspot{background:#ffd700;color:#0d0d0d;border:none;border-radius:20px;
      padding:2px 8px;font-weight:700;box-shadow:0 0 0 2px rgba(0,0,0,.35)}
    .hotspot.active{outline:3px solid #00f7ff}

    /* Checklist */
    .list{display:flex;flex-direction:column;gap:12px}
    .item{border:1px dashed var(--gold-20);border-radius:12px;padding:12px}
    .item h4{margin:0 0 6px 0}
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .row .note{flex:1;min-width:200px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#26323d;color:#ddd;font-size:.85rem}
    .ok{background:#114d2b;color:#b8ffcc}
    .obs{background:#4d4111;color:#ffe9b8}
    .nok{background:#4d1111;color:#ffb8b8}
    .muted{opacity:.8}

    /* Contexto */
    .ctx{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    @media (max-width: 820px){.ctx{grid-template-columns:1fr 1fr}}
    .ctx input{width:100%}

    /* Pie acciones */
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    .right{margin-left:auto}
    .small-note{font-size:.9rem;color:#aebbc8}
  </style>
</head>
<body>
<header class="top">
  <h1>AURUM‚àû</h1>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="vision.html">Visi√≥n</a>
    <a href="modulos.html" class="active">M√≥dulos</a>
    <a href="contacto.html">Contacto</a>
  </nav>
</header>

<main>
  <h2>Checklist T√©cnico 3D</h2>

  <!-- CONTEXTO -->
  <section class="card">
    <h3>Contexto</h3>
    <div class="ctx">
      <label>
        <div class="small-note">ID Activo (QR / interno)</div>
        <input id="ctx-id" type="text" placeholder="Ej: HILUX-A8-001" />
      </label>
      <label>
        <div class="small-note">Nombre / Descripci√≥n</div>
        <input id="ctx-name" type="text" placeholder="Toyota Hilux ‚Äî Check 50 pts" />
      </label>
      <label>
        <div class="small-note">Operador</div>
        <input id="ctx-operator" type="text" placeholder="Andr√©s Bello" />
      </label>
      <label>
        <div class="small-note">Ubicaci√≥n (GPS)</div>
        <div class="row">
          <button class="btn small alt" id="btn-gps">Obtener ubicaci√≥n</button>
          <span id="gps" class="small-note">Lat: ‚Äî, Lng: ‚Äî</span>
        </div>
      </label>
    </div>
    <div class="row" style="margin-top:8px;">
      <span class="small-note">Accesos r√°pidos:</span>
      <a class="badge" href="numerologia.html">Numerolog√≠a</a>
      <a class="badge" href="trazabilidad.html">Trazabilidad</a>
      <a class="badge" href="hilux.html">Hilux 3D</a>
    </div>
  </section>

  <section class="grid">
    <!-- VISOR + CONTROLES -->
    <section class="card">
      <h3>Visor 3D</h3>
      <model-viewer id="visor"
        src=""                      <!-- ‚úÖ cambia a hilux.glb o Modulos/Hilux/hilux.glb -->
        ar ar-modes="webxr scene-viewer quick-look"
        camera-controls
        environment-image="neutral"
        exposure="1"
        shadow-intensity="1"
        camera-orbit="0deg 75deg 3.2m"
        min-camera-orbit="auto auto 1.2m"
        max-camera-orbit="auto auto 8m"
        min-field-of-view="15deg"
        max-field-of-view="65deg"
        interaction-prompt="none"
        alt="Visor 3D para inspecci√≥n">
        
        <!-- üîπ Hotspots de ejemplo (ajusta posiciones al cargar tu GLB) -->
        <button class="hotspot" slot="hotspot-1" data-surface="true"
          data-position="1m 1.2m 0.4m" data-normal="0 1 0"
          data-idx="1">1</button>
        <button class="hotspot" slot="hotspot-2" data-surface="true"
          data-position="-0.9m 1.1m 0.6m" data-normal="0 1 0"
          data-idx="2">2</button>
        <button class="hotspot" slot="hotspot-3" data-surface="true"
          data-position="0m 0.8m 1.6m" data-normal="0 1 0"
          data-idx="3">3</button>
        <button class="hotspot" slot="hotspot-4" data-surface="true"
          data-position="0.8m 0.9m -1.0m" data-normal="0 1 0"
          data-idx="4">4</button>
        <button class="hotspot" slot="hotspot-5" data-surface="true"
          data-position="-0.8m 0.7m -1.1m" data-normal="0 1 0"
          data-idx="5">5</button>
      </model-viewer>

      <div class="mv-controls">
        <button class="btn small" id="btn-zoomin">Acercar</button>
        <button class="btn small" id="btn-zoomout">Alejar</button>
        <button class="btn small alt" id="btn-reset">Reiniciar vista</button>
        <button class="btn small alt" id="btn-autorotate">Auto-rotar: OFF</button>
        <a class="btn small" id="btn-ar" href="#" onclick="document.getElementById('visor').activateAR()">Ver en AR</a>
        <span class="small-note right">Tip: toca un n√∫mero en el modelo o ‚ÄúIr al punto‚Äù en la lista.</span>
      </div>
    </section>

    <!-- CHECKLIST LIGADO A HOTSPOTS -->
    <section class="card">
      <h3>Lista de puntos</h3>
      <div class="list" id="checklist">
        <!-- Cada item se vincula por data-idx con el hotspot -->
        <div class="item" data-idx="1">
          <h4>Punto 1 ¬∑ Lado derecho / Panel frontal</h4>
          <div class="row">
            <label><input type="radio" name="res-1" value="OK" checked/> <span class="badge ok">OK</span></label>
            <label><input type="radio" name="res-1" value="OBS"/> <span class="badge obs">Observaci√≥n</span></label>
            <label><input type="radio" name="res-1" value="NO"/> <span class="badge nok">No Conforme</span></label>
            <input class="note" type="text" placeholder="Comentario / hallazgo‚Ä¶" />
            <button class="btn small alt goto">Ir al punto</button>
          </div>
        </div>

        <div class="item" data-idx="2">
          <h4>Punto 2 ¬∑ Lado izquierdo / Puerta</h4>
          <div class="row">
            <label><input type="radio" name="res-2" value="OK" checked/> <span class="badge ok">OK</span></label>
            <label><input type="radio" name="res-2" value="OBS"/> <span class="badge obs">Observaci√≥n</span></label>
            <label><input type="radio" name="res-2" value="NO"/> <span class="badge nok">No Conforme</span></label>
            <input class="note" type="text" placeholder="Comentario / hallazgo‚Ä¶" />
            <button class="btn small alt goto">Ir al punto</button>
          </div>
        </div>

        <div class="item" data-idx="3">
          <h4>Punto 3 ¬∑ Cap√≥ / Motor</h4>
          <div class="row">
            <label><input type="radio" name="res-3" value="OK" checked/> <span class="badge ok">OK</span></label>
            <label><input type="radio" name="res-3" value="OBS"/> <span class="badge obs">Observaci√≥n</span></label>
            <label><input type="radio" name="res-3" value="NO"/> <span class="badge nok">No Conforme</span></label>
            <input class="note" type="text" placeholder="Comentario / hallazgo‚Ä¶" />
            <button class="btn small alt goto">Ir al punto</button>
          </div>
        </div>

        <div class="item" data-idx="4">
          <h4>Punto 4 ¬∑ Eje trasero / Suspensi√≥n</h4>
          <div class="row">
            <label><input type="radio" name="res-4" value="OK" checked/> <span class="badge ok">OK</span></label>
            <label><input type="radio" name="res-4" value="OBS"/> <span class="badge obs">Observaci√≥n</span></label>
            <label><input type="radio" name="res-4" value="NO"/> <span class="badge nok">No Conforme</span></label>
            <input class="note" type="text" placeholder="Comentario / hallazgo‚Ä¶" />
            <button class="btn small alt goto">Ir al punto</button>
          </div>
        </div>

        <div class="item" data-idx="5">
          <h4>Punto 5 ¬∑ Chasis / Bastidor</h4>
          <div class="row">
            <label><input type="radio" name="res-5" value="OK" checked/> <span class="badge ok">OK</span></label>
            <label><input type="radio" name="res-5" value="OBS"/> <span class="badge obs">Observaci√≥n</span></label>
            <label><input type="radio" name="res-5" value="NO"/> <span class="badge nok">No Conforme</span></label>
            <input class="note" type="text" placeholder="Comentario / hallazgo‚Ä¶" />
            <button class="btn small alt goto">Ir al punto</button>
          </div>
        </div>
      </div>

      <hr style="border-color:var(--gold-20);margin:14px 0">

      <div class="row">
        <label class="small-note">Adjuntar evidencia (im√°genes, PDFs)</label>
        <input type="file" id="files" multiple />
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="btn-save">Guardar local</button>
        <button class="btn alt" id="btn-load">Cargar guardado</button>
        <button class="btn alt" id="btn-clear">Borrar guardado</button>
        <button class="btn right" id="btn-export">Exportar CSV</button>
      </div>
      <div class="small-note" style="margin-top:8px">
        El guardado es local (navegador). Pronto lo enviaremos al backend cuando lo conectemos.
      </div>
    </section>
  </section>
</main>

<footer class="foot">¬© 2025 AURUM‚àû</footer>

<script>
  const visor = document.getElementById('visor');

  /* ==========================
   *  Controles de c√°mara / zoom
   * ========================== */
  const btnIn = document.getElementById('btn-zoomin');
  const btnOut = document.getElementById('btn-zoomout');
  const btnReset = document.getElementById('btn-reset');
  const btnAuto = document.getElementById('btn-autorotate');

  function getFov(){ return parseFloat(visor.getAttribute('field-of-view') || '45'); }
  function setFov(v){
    v = Math.max(15, Math.min(65, v));
    visor.setAttribute('field-of-view', v+'deg');
  }
  btnIn.onclick = () => setFov(getFov()-5);
  btnOut.onclick = () => setFov(getFov()+5);

  btnReset.onclick = () => {
    visor.cameraOrbit = '0deg 75deg 3.2m';
    setFov(45);
  };

  btnAuto.onclick = () => {
    const on = visor.autoRotate;
    visor.autoRotate = !on;
    btnAuto.textContent = 'Auto-rotar: ' + (visor.autoRotate ? 'ON' : 'OFF');
  };

  /* ==========================
   *  Hotspots ‚Üî Checklist
   * ========================== */
  const hotspotEls = [...document.querySelectorAll('.hotspot')];
  const items = [...document.querySelectorAll('.item')];

  // click en hotspot ‚Üí resalta item y hace scroll
  hotspotEls.forEach(h => {
    h.addEventListener('click', () => {
      const idx = h.dataset.idx;
      setActiveHotspot(idx);
      focusItem(idx);
    });
  });

  // bot√≥n "Ir al punto" ‚Üí orbita c√°mara hacia hotspot (si el GLB est√°)
  items.forEach(it => {
    it.querySelector('.goto').addEventListener('click', () => {
      const idx = it.dataset.idx;
      setActiveHotspot(idx);
      // Opcional: cambiar ligeramente la √≥rbita para sugerir movimiento
      // (Sin coordenadas exactas de c√°mara, esto es una animaci√≥n simple)
      visor.cameraOrbit = `${(idx*35)%360}deg 70deg 3m`;
    });
  });

  function setActiveHotspot(idx){
    hotspotEls.forEach(h => h.classList.toggle('active', h.dataset.idx===idx));
  }
  function focusItem(idx){
    const el = items.find(x => x.dataset.idx===idx);
    if(!el) return;
    el.scrollIntoView({behavior:'smooth',block:'center'});
    el.style.boxShadow = '0 0 0 3px #00f7ff66';
    setTimeout(()=> el.style.boxShadow = '', 1200);
  }

  /* ==========================
   *  GPS
   * ========================== */
  const gpsSpan = document.getElementById('gps');
  document.getElementById('btn-gps').onclick = () => {
    if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const {latitude, longitude} = pos.coords;
        gpsSpan.textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
      },
      err => { alert('No se pudo obtener la ubicaci√≥n'); console.error(err); },
      {enableHighAccuracy:true, timeout:8000}
    );
  };

  /* ==========================
   *  Guardado local / CSV
   * ========================== */
  const ctxId = document.getElementById('ctx-id');
  const ctxName = document.getElementById('ctx-name');
  const ctxOp = document.getElementById('ctx-operator');
  const filesInput = document.getElementById('files');

  function storageKey(){
    const id = (ctxId.value||'').trim() || 'SIN-ID';
    return `aurum_checklist_${id}`;
  }

  function collectData(){
    const data = {
      id: ctxId.value||'',
      name: ctxName.value||'',
      operator: ctxOp.value||'',
      gps: gpsSpan.textContent.replace('Lat: ','').replace('Lng: ',''),
      date: new Date().toISOString(),
      items: items.map(it => {
        const idx = it.dataset.idx;
        const val = (it.querySelector('input[type=radio]:checked')||{}).value || 'OK';
        const note = it.querySelector('.note').value || '';
        return {idx, result: val, note};
      }),
      files: [...filesInput.files].map(f => f.name)
    };
    return data;
  }

  function fillFromData(data){
    ctxId.value = data.id||'';
    ctxName.value = data.name||'';
    ctxOp.value = data.operator||'';
    if(data.gps) gpsSpan.textContent = 'Lat: ' + data.gps;

    (data.items||[]).forEach(d => {
      const it = items.find(x => x.dataset.idx===d.idx);
      if(!it) return;
      const radios = it.querySelectorAll('input[type=radio]');
      radios.forEach(r => r.checked = (r.value === d.result));
      it.querySelector('.note').value = d.note||'';
    });
  }

  document.getElementById('btn-save').onclick = () => {
    const data = collectData();
    localStorage.setItem(storageKey(), JSON.stringify(data));
    alert('Guardado local OK');
  };
  document.getElementById('btn-load').onclick = () => {
    const raw = localStorage.getItem(storageKey());
    if(!raw){ alert('No hay guardado para este ID'); return; }
    fillFromData(JSON.parse(raw));
    alert('Cargado');
  };
  document.getElementById('btn-clear').onclick = () => {
    localStorage.removeItem(storageKey());
    alert('Guardado eliminado para este ID');
  };

  // CSV
  document.getElementById('btn-export').onclick = () => {
    const d = collectData();
    const rows = [
      ['ID','Nombre','Operador','FechaISO','GPS','Idx','Resultado','Nota','Archivos'],
      ...d.items.map(it => [d.id, d.name, d.operator, d.date, d.gps, it.idx, it.result, it.note, d.files.join('|')])
    ];
    const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${d.id || 'checklist'}_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  /* ==========================
   *  Sugerencias de uso
   * ==========================
   * 1) Cambia el atributo src del <model-viewer> a:
   *    src="Modulos/Hilux/hilux.glb"  (o el glb que subas)
   * 2) Ajusta las posiciones de los hotspots (data-position) seg√∫n tu GLB.
   * 3) Agrega m√°s puntos clonando bloques .item y botones hotspot.
   */
</script>
</body>
</html>