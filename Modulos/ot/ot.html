<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Órdenes de Trabajo • AURUM∞</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="lemuria.css" />
  <style>
    .grid{display:grid;gap:16px}
    @media(min-width:920px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--bg-card);border:1px solid var(--gold-20);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px dashed var(--gold-20);padding:10px 8px;text-align:left}
    th{color:var(--gold)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  </style>
</head>
<body>
<header class="top">
  <h1>AURUM∞</h1>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="vision.html">Visión</a>
    <a href="modulos.html">Módulos</a>
    <a href="contacto.html">Contacto</a>
  </nav>
</header>

<main class="container grid">
  <section class="card">
    <h2>Nueva OT</h2>
    <form id="frm" autocomplete="off">
      <input type="hidden" id="idx" value="-1" />
      <label>Código</label><input id="cod" placeholder="OT-0001" required />
      <label>Activo</label><input id="act" placeholder="HILUX-A8-001" />
      <label>Prioridad</label>
      <select id="pri"><option>Alta</option><option>Media</option><option>Baja</option></select>
      <label>Estado</label>
      <select id="est"><option>Pendiente</option><option>En curso</option><option>Cerrada</option></select>
      <label>Descripción</label><textarea id="des" rows="4" placeholder="Trabajo a realizar…"></textarea>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn gold">Guardar</button>
        <button type="button" id="limpiar" class="btn">Limpiar</button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>Órdenes</h2>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Buscar…" />
      <select id="fEstado">
        <option value="">Estado: todos</option>
        <option>Pendiente</option><option>En curso</option><option>Cerrada</option>
      </select>
      <select id="fPri">
        <option value="">Prioridad: todas</option>
        <option>Alta</option><option>Media</option><option>Baja</option>
      </select>
      <div style="flex:1"></div>
      <button id="csv" class="btn gold">Exportar CSV</button>
      <button id="wipe" class="btn">Borrar todo</button>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Código</th><th>Activo</th><th>Prioridad</th><th>Estado</th><th>Descripción</th><th>Acciones</th></tr></thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="footer">© 2025 AURUM∞</footer>

<script>
  const KEY='aurum_ot';
  const $=s=>document.querySelector(s);
  const frm=$('#frm'), body=$('#body');
  const leer=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
  const guardar=arr=>localStorage.setItem(KEY,JSON.stringify(arr));

  function pintar(){
    const q=$('#q').value.toLowerCase(), fe=$('#fEstado').value, fp=$('#fPri').value;
    body.innerHTML = leer()
      .map((r,i)=>({...r,i}))
      .filter(r=>(!q|| (r.cod+r.act+r.des).toLowerCase().includes(q)) && (!fe||r.est===fe) && (!fp||r.pri===fp))
      .map(r=>`<tr>
        <td>${esc(r.cod)}</td><td>${esc(r.act||'')}</td><td>${esc(r.pri)}</td><td>${esc(r.est)}</td>
        <td>${esc(r.des||'')}</td>
        <td><button class="btn" data-e="${r.i}">Editar</button> <button class="btn" data-d="${r.i}">Borrar</button></td>
      </tr>`).join('') || `<tr><td colspan="6" class="muted">Sin OT…</td></tr>`;
  }
  function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

  frm.addEventListener('submit',e=>{
    e.preventDefault();
    const r={cod:$('#cod').value.trim(), act:$('#act').value.trim(), pri:$('#pri').value, est:$('#est').value, des:$('#des').value.trim()};
    const arr=leer(); const i=parseInt($('#idx').value,10);
    if(Number.isInteger(i)&&i>=0) arr[i]=r; else arr.push(r);
    guardar(arr); limpiar(); pintar();
  });
  function limpiar(){ frm.reset(); $('#idx').value=-1; $('#cod').focus(); }
  $('#limpiar').onclick=limpiar;

  body.addEventListener('click',e=>{
    const iE=e.target.getAttribute('data-e'), iD=e.target.getAttribute('data-d');
    if(iE){ const r=leer()[+iE]; $('#idx').value=iE; $('#cod').value=r.cod; $('#act').value=r.act||''; $('#pri').value=r.pri; $('#est').value=r.est; $('#des').value=r.des||''; window.scrollTo({top:0,behavior:'smooth'}); }
    if(iD){ const arr=leer(); arr.splice(+iD,1); guardar(arr); pintar(); }
  });

  $('#q').oninput=$('#fEstado').onchange=$('#fPri').onchange=pintar;

  $('#csv').onclick=()=>{
    const head=['Código','Activo','Prioridad','Estado','Descripción'];
    const esc=v=>`"${(v||'').toString().replace(/"/g,'""')}"`;
    const csv=[head.join(',')].concat(leer().map(r=>[r.cod,r.act,r.pri,r.est,r.des].map(esc).join(','))).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='ot_aurum.csv'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#wipe').onclick=()=>{ if(confirm('¿Borrar todas las OT locales?')){ localStorage.removeItem(KEY); pintar(); } };
  pintar();
</script>
</body>
</html>