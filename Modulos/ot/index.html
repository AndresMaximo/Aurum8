<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AURUM∞ • Órdenes de Trabajo (OT)</title>

  <!-- Fuentes + tema global -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/aurum-theme.css" />

  <style>
    .screen{max-width:1100px;margin:40px auto;padding:24px}
    header.top{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:14px}
    header.top h1{font-family:var(--brand);font-size:clamp(22px,4vw,32px);letter-spacing:.08em;color:var(--ink);text-shadow:0 0 18px rgba(0,255,160,.15)}
    .navlinks a{color:var(--ink);opacity:.85;margin-left:12px;text-decoration:none}
    .navlinks a:hover{opacity:1;text-shadow:0 0 10px rgba(0,255,160,.4)}
    .panel{background:var(--bg-card);border:1px solid var(--gold-20);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin:18px 0}
    .row{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    label{font:600 12px var(--ui);letter-spacing:.06em}
    input,select,textarea{margin-top:6px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02);color:var(--ink);outline:none}
    textarea{min-height:90px}
    .actions{display:flex;gap:10px;justify-content:flex-end}
    button.primary{padding:10px 14px;border-radius:12px;border:1px solid var(--gold-20);
      background:linear-gradient(130deg,#00ffd0 0%,#38ffa6 100%);color:#001a18;font-weight:700;letter-spacing:.04em;box-shadow:0 0 18px rgba(0,255,160,.25)}
    button.ghost{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--ink)}
    .muted{opacity:.75}
    .table{overflow:auto;border:1px solid var(--gold-20);border-radius:16px;background:var(--bg-card);box-shadow:var(--shadow)}
    table{width:100%;border-collapse:collapse;min-width:860px}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,255,200,.07),rgba(0,0,0,.2));
      font:600 12px var(--ui);text-transform:uppercase;letter-spacing:.1em;color:var(--ink);padding:12px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);font:400 14px var(--ui)}
    tbody tr:hover{background:rgba(0,255,200,.04)}
    .right{text-align:right}
    .pill{display:inline-block;padding:.2rem .55rem;border-radius:999px;border:1px solid var(--gold-20)}
    .ok{background:rgba(0,255,200,.1)}
    .warn{background:rgba(250,200,0,.08);border-color:#ffd26a}
    .bad{background:rgba(255,100,100,.1);border-color:#ff8080;color:#ff9ea1}
    .spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#00ffd0;animation:spin 1s linear infinite;display:inline-block;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="screen">
    <header class="top">
      <h1>Órdenes de Trabajo</h1>
      <div class="navlinks">
        <a href="/">Portal</a>
        <a href="/Modulos/recursos-humanos/index.html">Recursos Humanos</a>
        <a href="/Modulos/hilux/index.html">Hilux • Checklist</a>
      </div>
    </header>

    <!-- Crear OT -->
    <div class="panel">
      <div class="row">
        <label>Equipo / Activo
          <input id="equipo" placeholder="Hilux ABC-123, Bomba 8x8, Feeder FEE43…" />
        </label>
        <label>Tipo de OT
          <select id="tipo">
            <option value="mantenimiento">Mantenimiento</option>
            <option value="correctivo">Correctivo</option>
            <option value="inspeccion">Inspección</option>
          </select>
        </label>
        <label>Estado inicial
          <select id="estado">
            <option value="pendiente">Pendiente</option>
            <option value="en_proceso">En proceso</option>
            <option value="cerrada">Cerrada</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>Descripción
          <textarea id="desc" placeholder="Detalle breve de la intervención"></textarea>
        </label>
        <label>Asignar trabajadores (Ctrl/Cmd para multi‑select)
          <select id="workers" multiple style="height:140px"></select>
        </label>
      </div>

      <div class="actions">
        <button id="btnCrear" class="primary">Crear OT</button>
        <button id="btnRef" class="ghost">Refrescar listado</button>
      </div>
    </div>

    <!-- Listado OT -->
    <div class="panel">
      <div class="row">
        <label>Filtrar por estado
          <select id="fEstado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en_proceso">En proceso</option>
            <option value="cerrada">Cerrada</option>
          </select>
        </label>
        <label>Búsqueda
          <input id="q" placeholder="Equipo / Tipo / Descripción">
        </label>
        <label>Ordenar por
          <select id="sortBy">
            <option value="fecha_inicio">Fecha inicio</option>
            <option value="equipo">Equipo</option>
            <option value="tipo">Tipo</option>
            <option value="estado">Estado</option>
          </select>
        </label>
      </div>
    </div>

    <div class="table">
      <table>
        <thead>
          <tr>
            <th>Equipo</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Asignados</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <p id="status" class="muted" style="margin-top:10px"></p>
  </div>

  <script src="/aurum.js"></script>
  <script>
    const $ = (s,c=document)=>c.querySelector(s);
    const tbody   = $('#tbody');
    const statusEl= $('#status');

    function pillEstado(est){
      if(est==='cerrada') return `<span class="pill ok">CERRADA</span>`;
      if(est==='en_proceso') return `<span class="pill warn">EN PROCESO</span>`;
      return `<span class="pill bad">PENDIENTE</span>`;
    }

    function row(ot){
      const asignados = (ot.trabajadores?.length || 0);
      const fin = ot.fecha_fin ? new Date(ot.fecha_fin).toLocaleString('es-CL') : '—';
      return `
        <tr data-id="${ot.id}">
          <td>${ot.equipo}</td>
          <td class="muted">${ot.tipo}</td>
          <td>${pillEstado(ot.estado)}</td>
          <td>${new Date(ot.fecha_inicio).toLocaleString('es-CL')}</td>
          <td>${fin}</td>
          <td>
            ${asignados} 
            <button class="ghost" data-ver="${ot.id}" title="Ver asignados">Ver</button>
          </td>
          <td class="right">
            <button class="ghost" data-proc="${ot.id}">Marcar EN PROCESO</button>
            <button class="ghost" data-close="${ot.id}">Cerrar</button>
            <button class="ghost" data-del="${ot.id}">Eliminar</button>
          </td>
        </tr>`;
    }

    // Cargar select de trabajadores
    async function cargarTrabajadoresSelect(){
      const sel = $('#workers');
      const { data, error } = await window.db
        .from('recursos_humanos').select('id,nombre').order('nombre');
      if(error){ console.error(error); return; }
      sel.innerHTML = data.map(t => `<option value="${t.id}">${t.nombre}</option>`).join('');
    }

    // Crear OT + asignaciones
    async function crearOT(){
      const equipo = $('#equipo').value.trim();
      const tipo   = $('#tipo').value;
      const estado = $('#estado').value;
      const desc   = $('#desc').value.trim() || null;
      if(!equipo){ window.toast?.('Escribe el equipo/activo'); return; }

      const { data, error } = await window.db
        .from('ordenes_trabajo')
        .insert({ equipo, tipo, estado, descripcion: desc })
        .select('id')
        .single();
      if(error){ alert(error.message); return; }

      const otId = data.id;
      // asignaciones
      const sel = $('#workers');
      const ids = Array.from(sel.selectedOptions).map(o => o.value);
      if(ids.length){
        const rows = ids.map(trabajador_id => ({ ot_id: otId, trabajador_id }));
        const { error: e2 } = await window.db.from('ot_trabajadores').insert(rows);
        if(e2) alert(e2.message);
      }

      $('#equipo').value=''; $('#desc').value='';
      sel.selectedIndex = -1;
      window.toast?.('OT creada ✅');
      cargarListado();
    }

    // Listado OT con trabajadores
    async function cargarListado(){
      statusEl.innerHTML = '<span class="spinner"></span> Cargando…';
      const q = ($('#q')?.value || '').trim();
      const sortBy = $('#sortBy')?.value || 'fecha_inicio';
      const fEstado = $('#fEstado')?.value || '';

      // 1) Traer OTs
      let req = window.db
        .from('ordenes_trabajo')
        .select('id,equipo,tipo,estado,fecha_inicio,fecha_fin,descripcion')
        .order(sortBy, { ascending: sortBy!=='fecha_inicio' });

      if(fEstado) req = req.eq('estado', fEstado);
      if(q) req = req.or(`equipo.ilike.%${q}%,tipo.ilike.%${q}%,descripcion.ilike.%${q}%`);

      const { data: ots, error } = await req;
      if(error){ statusEl.textContent='Error: '+error.message; return; }

      // 2) Contar asignados por OT
      const ids = ots.map(o=>o.id);
      let asignaciones = [];
      if(ids.length){
        const { data: rows } = await window.db
          .from('ot_trabajadores')
          .select('ot_id, trabajador_id, recursos_humanos(nombre)')
          .in('ot_id', ids);
        asignaciones = rows || [];
      }
      const group = asignaciones.reduce((acc,r)=>{
        (acc[r.ot_id] ||= []).push(r.recursos_humanos?.nombre || '—');
        return acc;
      }, {});

      const model = ots.map(o => ({...o, trabajadores: group[o.id] || []}));

      tbody.innerHTML = model.length ? model.map(row).join('') :
        `<tr><td colspan="7" class="muted" style="text-align:center;padding:18px">Sin OTs</td></tr>`;
      statusEl.textContent = `${model.length} OT(s)`;
    }

    // Ver asignados, cambiar estados, eliminar
    tbody.addEventListener('click', async (e)=>{
      const id = e.target.dataset.ver || e.target.dataset.proc || e.target.dataset.close || e.target.dataset.del;
      if(!id) return;

      // Ver asignados (alert simple)
      if(e.target.dataset.ver){
        const { data } = await window.db
          .from('ot_trabajadores')
          .select('recursos_humanos(nombre)')
          .eq('ot_id', id);
        const lista = (data||[]).map(r=>`• ${r.recursos_humanos?.nombre}`).join('\n') || '—';
        alert('Trabajadores asignados:\n\n'+lista);
      }

      // Marcar EN PROCESO
      if(e.target.dataset.proc){
        const { error } = await window.db.from('ordenes_trabajo')
          .update({ estado: 'en_proceso', fecha_fin: null })
          .eq('id', id);
        if(error) return alert(error.message);
        cargarListado();
      }

      // Cerrar OT (setea fecha_fin)
      if(e.target.dataset.close){
        const { error } = await window.db.from('ordenes_trabajo')
          .update({ estado: 'cerrada', fecha_fin: new Date().toISOString() })
          .eq('id', id);
        if(error) return alert(error.message);
        cargarListado();
      }

      // Eliminar OT
      if(e.target.dataset.del){
        if(!confirm('¿Eliminar OT?')) return;
        const { error } = await window.db.from('ordenes_trabajo').delete().eq('id', id);
        if(error) return alert(error.message);
        cargarListado();
      }
    });

    // Eventos UI
    $('#btnCrear').addEventListener('click', crearOT);
    $('#btnRef').addEventListener('click', cargarListado);
    $('#q')?.addEventListener('input', debounce(cargarListado, 250));
    $('#fEstado')?.addEventListener('change', cargarListado);
    $('#sortBy')?.addEventListener('change', cargarListado);
    function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    // Inicio
    (async function init(){
      await cargarTrabajadoresSelect();
      await cargarListado();
    })();
  </script>
</body>
</html>