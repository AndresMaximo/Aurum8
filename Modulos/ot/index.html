<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AURUM∞ · Órdenes de Trabajo</title>

  <!-- Tema base de AURUM (mismos colores y tipografía) -->
  <link rel="stylesheet" href="/aurum-theme.css" />

  <!-- Topbar común -->
  <link rel="stylesheet" href="/Modulos/common/topbar.css" />
  <style>
    /* Ajustes locales del módulo */
    .page {
      max-width: 1100px;
      margin: 120px auto 64px;
      padding: 0 16px;
    }

    .panel {
      background: rgba(8, 22, 33, 0.6);
      border: 1px solid rgba(120,255,233,0.22);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 0 40px rgba(120,255,233,0.06);
      padding: 20px;
      margin-bottom: 24px;
    }

    .panel h2 {
      margin: 0 0 8px;
      letter-spacing: .04em;
      color: #b8fff5;
      text-shadow: 0 0 10px rgba(120,255,233,.25);
      font-weight: 700;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    label {
      font-size: .9rem;
      color: #cfeff0;
      display: block;
      margin-bottom: 8px;
    }

    input, select, textarea {
      width: 100%;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(120,255,233,0.18);
      color: #e9fffb;
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }
    input::placeholder, textarea::placeholder { color: #8fb3b5; }

    .btn {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(120,255,233,0.25);
      color: #001f25;
      background: linear-gradient(135deg,#86ffe9,#18f8c2 55%,#34ffd6);
      font-weight: 700;
      letter-spacing: .02em;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn:hover { transform: translateY(-1px); filter: saturate(1.1); }
    .btn:active { transform: translateY(0); }

    table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 12px;
    }
    thead th {
      text-align: left;
      font-size: .85rem;
      color: #8feee0;
      padding: 12px;
      background: rgba(120,255,233,.075);
      border-bottom: 1px solid rgba(120,255,233,.15);
    }
    tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(120,255,233,.08);
      color: #e6fffb;
      vertical-align: top;
    }
    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .8rem;
      border: 1px solid rgba(120,255,233,.35);
      background: rgba(120,255,233,.08);
    }
    .muted { color:#a6c9cb; font-size:.85rem; }

    .row-actions {
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .row-actions .btn {
      background: transparent;
      color:#9bf3e7;
      border-color: rgba(120,255,233,.35);
      padding:6px 10px;
    }
  </style>
</head>
<body>

  <!-- Topbar común (se inyecta por JS para reusar en todos los módulos) -->
  <div id="topbar"></div>

  <main class="page">
    <section class="panel">
      <h2>Crear nueva OT</h2>
      <form id="ot-form" class="grid">
        <div>
          <label>Equipo</label>
          <input id="equipo" type="text" placeholder="Ej: Hilux PPU-XXXX" required />
        </div>
        <div>
          <label>Tipo</label>
          <select id="tipo" required>
            <option value="preventivo">Preventivo</option>
            <option value="correctivo">Correctivo</option>
            <option value="inspeccion">Inspección</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div>
          <label>Fecha inicio</label>
          <input id="fecha_inicio" type="datetime-local" />
        </div>
        <div>
          <label>Fecha fin (opcional)</label>
          <input id="fecha_fin" type="datetime-local" />
        </div>
        <div style="grid-column: 1 / -1; display:flex; gap:12px; align-items:end;">
          <button class="btn" type="submit">Guardar OT</button>
          <span id="form-msg" class="muted"></span>
        </div>
      </form>
    </section>

    <section class="panel">
      <h2>Listado de Órdenes de Trabajo</h2>
      <div class="muted" style="margin-bottom:8px;">Se muestran las últimas 100 OTs.</div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="ot-body">
            <tr><td class="muted" colspan="6">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- SDK Supabase y cliente compartido -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/aurum.js"></script>

  <script>
    // Cargar topbar común
    (async () => {
      try {
        const html = await fetch('/Modulos/common/topbar.html',{cache:"no-store"}).then(r=>r.text());
        document.getElementById('topbar').innerHTML = html;
      } catch(e) { console.warn('Topbar no disponible:', e); }
    })();

    // Helpers UI
    const toast = (msg) => {
      const el = document.getElementById('form-msg');
      el.textContent = msg;
      setTimeout(()=> el.textContent = '', 2500);
    };

    // Referencias DOM
    const $body = document.getElementById('ot-body');
    const $form = document.getElementById('ot-form');
    const $equipo = document.getElementById('equipo');
    const $tipo = document.getElementById('tipo');
    const $inicio = document.getElementById('fecha_inicio');
    const $fin = document.getElementById('fecha_fin');

    // Listar OTs
    async function cargarOTs() {
      $body.innerHTML = `<tr><td class="muted" colspan="6">Cargando…</td></tr>`;
      const { data, error } = await window.db
        .from('ordenes_trabajo')
        .select('*')
        .order('fecha_inicio', { ascending: false })
        .limit(100);

      if (error) {
        $body.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`;
        return;
      }
      if (!data || !data.length) {
        $body.innerHTML = `<tr><td class="muted" colspan="6">No hay registros aún.</td></tr>`;
        return;
      }
      $body.innerHTML = data.map(ot => `
        <tr data-id="${ot.id}">
          <td>${ot.equipo ?? ''}</td>
          <td>${ot.tipo ?? ''}</td>
          <td><span class="status">${ot.estado ?? 'pendiente'}</span></td>
          <td>${fmt(ot.fecha_inicio)}</td>
          <td>${fmt(ot.fecha_fin)}</td>
          <td class="row-actions">
            <button class="btn" data-accion="cerrar">Cerrar</button>
            <button class="btn" data-accion="eliminar">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    function fmt(x) {
      if (!x) return '<span class="muted">—</span>';
      try { return new Date(x).toLocaleString(); } catch { return x; }
    }

    // Crear OT
    $form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        equipo: $equipo.value.trim(),
        tipo: $tipo.value,
        estado: 'pendiente',
        fecha_inicio: $inicio.value ? new Date($inicio.value).toISOString() : new Date().toISOString(),
        fecha_fin: $fin.value ? new Date($fin.value).toISOString() : null
      };
      const { error } = await window.db.from('ordenes_trabajo').insert(payload);
      if (error) { toast('Error: ' + error.message); return; }
      $form.reset();
      toast('OT creada');
      cargarOTs();
    });

    // Acciones por fila
    $body.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = e.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;

      const accion = btn.dataset.accion;
      if (accion === 'cerrar') {
        const { error } = await window.db.from('ordenes_trabajo')
          .update({ estado: 'cerrada', fecha_fin: new Date().toISOString() })
          .eq('id', id);
        if (error) { toast('Error: ' + error.message); return; }
        toast('OT cerrada');
        cargarOTs();
      }

      if (accion === 'eliminar') {
        if (!confirm('¿Eliminar esta OT?')) return;
        const { error } = await window.db.from('ordenes_trabajo').delete().eq('id', id);
        if (error) { toast('Error: ' + error.message); return; }
        toast('OT eliminada');
        cargarOTs();
      }
    });

    cargarOTs();
  </script>
</body>
</html>