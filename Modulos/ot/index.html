<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Órdenes de Trabajo · AURUM∞</title>

  <!-- Tema global -->
  <link rel="stylesheet" href="../../aurum-theme.css" />

  <!-- Topbar común -->
  <link rel="stylesheet" href="../common/topbar.css" />

  <style>
    .wrap { max-width: 1100px; margin: 0 auto; padding: 1.25rem; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px,1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .card { background: rgba(10, 25, 40, .6); border: 1px solid #2c5c7a; border-radius: 14px; padding: 1rem; }
    .card h2 { margin: .25rem 0 1rem; font-size: 1.25rem; color: #aef9f1; letter-spacing: .03em; }
    .field { display:flex; flex-direction:column; gap:.35rem; margin-bottom:.85rem; }
    .field label { font-size:.9rem; color:#8fd6cf; }
    .field input, .field select {
      background: rgba(255,255,255,.03);
      border: 1px solid #345d70; color:#dff; padding:.6rem .7rem; border-radius:10px; outline:none;
    }
    .btn {
      border:1px solid #36d6b4; background: rgba(54,214,180,.1);
      color:#bffef4; padding:.65rem .9rem; border-radius:12px; cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#7fb6b0; font-size:.9rem; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:.65rem .6rem; border-bottom:1px solid rgba(70,130,160,.35); }
    th { text-align:left; color:#a4f1ea; font-weight:600; }
    tr:hover { background: rgba(255,255,255,.03); }
    .pill {
      display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.75rem;
      border:1px solid #3fa0c9; color:#aee8ff;
    }
    .space { height:.75rem; }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div id="topbar"></div>
  <script>
    fetch("../common/topbar.html").then(r=>r.text()).then(h=>document.getElementById("topbar").innerHTML=h);
  </script>

  <main class="wrap">
    <h1 style="letter-spacing:.06em; color:#c0fff7;">Órdenes de Trabajo</h1>
    <p class="muted">Crea una nueva OT y visualiza las más recientes. Todo se guarda en Supabase (si hay conexión); si no, se usa almacenamiento local para pruebas.</p>

    <div class="grid">
      <!-- Crear OT -->
      <section class="card">
        <h2>Nueva OT</h2>
        <form id="form-ot">
          <div class="field">
            <label for="equipo">Equipo</label>
            <input id="equipo" name="equipo" type="text" placeholder="Hilux, Bomba, Feeder, etc." required />
          </div>

          <div class="field">
            <label for="tipo">Tipo</label>
            <select id="tipo" name="tipo" required>
              <option value="Inspección">Inspección</option>
              <option value="Correctivo">Correctivo</option>
              <option value="Preventivo">Preventivo</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div class="field">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
              <option value="pendiente">pendiente</option>
              <option value="en_proceso">en_proceso</option>
              <option value="cerrada">cerrada</option>
            </select>
          </div>

          <button class="btn" id="btn-crear" type="submit">Crear OT</button>
          <span id="msg" class="muted" style="margin-left:.6rem;"></span>
        </form>
      </section>

      <!-- Listado -->
      <section class="card">
        <h2>Listado reciente</h2>
        <div class="space"></div>
        <table>
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Inicio</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </div>
  </main>

  <!-- SDK Supabase + cliente global -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="../../aurum.js"></script>

  <script>
    // Utilidades
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => [...root.querySelectorAll(q)];
    const toast = (t) => { const el=$("#msg"); if(!el) return; el.textContent=t; setTimeout(()=>el.textContent="", 3000); };

    // Fallback local si no hay window.db
    const localKey = "aurum_ot_local_v1";
    const localOT = {
      all: () => JSON.parse(localStorage.getItem(localKey) || "[]"),
      push: (row) => { const a = localOT.all(); a.unshift(row); localStorage.setItem(localKey, JSON.stringify(a)); },
    };

    async function cargar() {
      const tbody = $("#tbody");
      tbody.innerHTML = `<tr><td class="muted" colspan="4">Cargando…</td></tr>`;

      // Si existe Supabase
      if (window.db) {
        const { data, error } = await window.db
          .from("ordenes_trabajo")
          .select("id,equipo,tipo,estado,fecha_inicio")
          .order("fecha_inicio", { ascending: false })
          .limit(20);

        if (error) {
          console.error(error);
          tbody.innerHTML = `<tr><td class="muted" colspan="4">Error al cargar. Modo local habilitado.</td></tr>`;
          pintarLocal();
          return;
        }
        pintar(data || []);
      } else {
        // Modo local
        pintarLocal();
      }
    }

    function pintarLocal() {
      const rows = localOT.all();
      pintar(rows);
    }

    function pintar(rows) {
      const tbody = $("#tbody");
      if (!rows.length) {
        tbody.innerHTML = `<tr><td class="muted" colspan="4">Sin registros.</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.equipo || "")}</td>
          <td><span class="pill">${escapeHtml(r.tipo || "")}</span></td>
          <td>${escapeHtml(r.estado || "")}</td>
          <td>${fmtFecha(r.fecha_inicio)}</td>
        </tr>
      `).join("");
    }

    function fmtFecha(v) {
      if (!v) return "";
      try { return new Date(v).toLocaleString(); } catch { return v; }
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
    }

    $("#form-ot").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("#btn-crear").disabled = true;

      const payload = {
        equipo: $("#equipo").value.trim(),
        tipo: $("#tipo").value,
        estado: $("#estado").value,
        fecha_inicio: new Date().toISOString()
      };

      try {
        if (window.db) {
          const { error } = await window.db.from("ordenes_trabajo").insert(payload);
          if (error) throw error;
          toast("OT creada");
        } else {
          // Guardar local si no hay DB
          localOT.push({ id: crypto.randomUUID(), ...payload });
          toast("OT creada (local)");
        }
        // limpiar e recargar
        e.target.reset();
        await cargar();
      } catch (err) {
        console.error(err);
        toast("Error al crear OT");
      } finally {
        $("#btn-crear").disabled = false;
      }
    });

    // inicia
    cargar();
  </script>
</body>
</html>