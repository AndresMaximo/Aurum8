<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√ìrdenes de Trabajo ‚Ä¢ AURUM‚àû</title>

  <!-- Estilos r√°pidos (usa tu lemuria.css si quieres, pero esto ya corre solo) -->
  <style>
    :root{
      --bg:#0b0f13;--panel:#121820;--ink:#e9edf1;--gold:#ffd43b;--gold-2:#c9a227;
      --ok:#1fbf75;--warn:#ffb200;--bad:#ff4d4d;--line:#1e2630;--muted:#9fb0c3;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--gold);text-decoration:none}
    header.top{position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(0,0,0,.85),rgba(0,0,0,.35));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:22px;margin:0}
    .crumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .crumbs a{font-size:14px;opacity:.9}
    main .grid{display:grid;gap:16px;grid-template-columns: 1fr}
    @media (min-width: 980px){ main .grid{grid-template-columns: 420px 1fr} }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px dashed var(--line);font-size:18px}
    .card .body{padding:16px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 4px}
    input[type="text"],input[type="date"],select,textarea{
      width:100%;background:#0d131a;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:15px;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;gap:10px}
    .row-2{grid-template-columns:repeat(2,1fr)}
    .row-3{grid-template-columns:repeat(3,1fr)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#0d131a}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{
      background:var(--gold);color:#141414;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer
    }
    button.ghost{background:#0d131a;color:var(--ink);border:1px solid var(--line)}
    button.red{background:var(--bad);color:#fff}
    button.green{background:var(--ok);color:#00110a}
    button.yellow{background:var(--warn);color:#221800}
    .list-head{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0d131a}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    tr:hover{background:#0e141b}
    .status{font-weight:700}
    .status.abierta{color:var(--warn)}
    .status.en-progreso{color:var(--gold)}
    .status.cerrada{color:var(--ok)}
    small.hint{color:var(--muted);display:block;margin-top:6px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#0e141b;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
    footer{color:var(--muted);text-align:center;padding:30px}
  </style>
</head>
<body>
  <!-- ENCABEZADO / MIGAS -->
  <header class="top">
    <div class="wrap">
      <div class="brand">
        <div style="width:28px;height:28px;border-radius:8px;background:radial-gradient(60% 80% at 30% 20%,#ffe88b,transparent 60%),linear-gradient(160deg,#ffe074,#af8922)"></div>
        <h1>AURUM‚àû ‚Ä¢ √ìrdenes de Trabajo</h1>
      </div>
      <nav class="crumbs">
        <a href="../../index.html">üè† Inicio</a>
        <span>‚Ä∫</span>
        <a href="../../index.html#modulos">M√≥dulos</a>
        <span>‚Ä∫</span>
        <span style="opacity:.72">OT</span>
      </nav>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="grid">
      <!-- LADO IZQUIERDO ‚Ä¢ FORMULARIO -->
      <section class="card">
        <h2>Nueva / Editar OT</h2>
        <div class="body">
          <div class="row row-2">
            <div>
              <label>N¬∞ OT</label>
              <input id="f-id" type="text" placeholder="Se genera autom√°tico si lo dejas vac√≠o">
            </div>
            <div>
              <label>Equipo / Activo</label>
              <input id="f-equipo" type="text" placeholder="Ej: Hilux A8-001">
            </div>
          </div>

          <div class="row row-2">
            <div>
              <label>Prioridad</label>
              <select id="f-prioridad">
                <option value="Baja">Baja</option>
                <option value="Media" selected>Media</option>
                <option value="Alta">Alta</option>
                <option value="Cr√≠tica">Cr√≠tica</option>
              </select>
            </div>
            <div>
              <label>Estado</label>
              <select id="f-estado">
                <option value="Abierta" selected>Abierta</option>
                <option value="En progreso">En progreso</option>
                <option value="Cerrada">Cerrada</option>
              </select>
            </div>
          </div>

          <div class="row row-2">
            <div>
              <label>Fecha inicio</label>
              <input id="f-inicio" type="date">
            </div>
            <div>
              <label>Fecha cierre</label>
              <input id="f-cierre" type="date">
            </div>
          </div>

          <div>
            <label>T√≠tulo</label>
            <input id="f-titulo" type="text" placeholder="Cambio de pastillas, revisi√≥n el√©ctrica, etc.">
          </div>

          <div>
            <label>Descripci√≥n</label>
            <textarea id="f-desc" placeholder="Breve detalle de la intervenci√≥n, condiciones, piezas, etc."></textarea>
          </div>

          <div>
            <label>Trabajadores asignados</label>
            <div class="row row-2">
              <div>
                <select id="f-trabajadores" multiple style="min-height:120px"></select>
                <small class="hint">Ctrl/Cmd + clic para seleccionar m√∫ltiples.</small>
              </div>
              <div>
                <label style="margin-top:0">Agregar trabajador r√°pido</label>
                <input id="f-nuevo-trabajador" type="text" placeholder="Nombre y apellido">
                <div class="toolbar" style="margin-top:8px">
                  <button class="ghost" id="btn-add-worker">+ Agregar a base local</button>
                  <button class="ghost" id="btn-del-worker">Eliminar seleccionado</button>
                </div>
                <small class="hint">La base de trabajadores se guarda en este navegador. Luego la conectaremos a la BD.</small>
              </div>
            </div>
          </div>

          <div>
            <label>Evidencia (s√≥lo nombre/URL por ahora)</label>
            <input id="f-evidencia" type="text" placeholder="Ej: foto_123.jpg o https://...">
          </div>

          <div class="toolbar" style="margin-top:14px">
            <button class="green" id="btn-save">Guardar OT</button>
            <button class="ghost" id="btn-clear">Limpiar</button>
            <button class="red" id="btn-delete" title="Elimina si est√°s editando una OT">Eliminar</button>
          </div>
        </div>
      </section>

      <!-- LADO DERECHO ‚Ä¢ LISTADO -->
      <section class="card">
        <h2>Listado y filtros</h2>
        <div class="body">
          <div class="list-head">
            <input id="q" class="pill" type="text" placeholder="Buscar por N¬∞ OT, equipo, t√≠tulo..." style="flex:1;min-width:220px">
            <select id="flt-estado" class="pill">
              <option value="">Estado: todos</option>
              <option>Abierta</option>
              <option>En progreso</option>
              <option>Cerrada</option>
            </select>
            <select id="flt-prioridad" class="pill">
              <option value="">Prioridad: todas</option>
              <option>Baja</option>
              <option>Media</option>
              <option>Alta</option>
              <option>Cr√≠tica</option>
            </select>
            <button class="ghost" id="btn-reset">Reiniciar</button>
          </div>

          <div class="toolbar" style="margin:8px 0 16px">
            <button class="yellow" id="btn-export">Exportar CSV</button>
            <button class="ghost" onclick="window.print()">Imprimir</button>
            <span style="flex:1"></span>
            <span id="count" class="hint"></span>
          </div>

          <div style="overflow:auto">
            <table id="tbl">
              <thead>
                <tr>
                  <th>N¬∞ OT</th>
                  <th>T√≠tulo</th>
                  <th>Equipo</th>
                  <th>Prioridad</th>
                  <th>Estado</th>
                  <th>Inicio</th>
                  <th>Cierre</th>
                  <th>Trabajadores</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>¬© 2025 AURUM‚àû ‚Ä¢ M√≥dulo de √ìrdenes de Trabajo (local)</footer>

  <!-- L√ìGICA -->
  <script>
    const LS_KEY_OTS = 'aurum_ot_v1';
    const LS_KEY_WORKERS = 'aurum_workers_v1';
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // ------- Trabajadores (base local)
    function loadWorkers(){
      const arr = JSON.parse(localStorage.getItem(LS_KEY_WORKERS)||'[]');
      const sel = $('#f-trabajadores');
      sel.innerHTML = '';
      arr.forEach(n=>{
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n;
        sel.appendChild(opt);
      });
      return arr;
    }
    function saveWorkers(arr){
      localStorage.setItem(LS_KEY_WORKERS, JSON.stringify(arr));
      loadWorkers();
    }

    // ------- √ìrdenes de trabajo
    function loadOTs(){
      return JSON.parse(localStorage.getItem(LS_KEY_OTS)||'[]');
    }
    function saveOTs(arr){
      localStorage.setItem(LS_KEY_OTS, JSON.stringify(arr));
      render();
    }
    function genId(){
      return 'OT-' + Math.random().toString(36).slice(2,7).toUpperCase();
    }

    // ------- CRUD b√°sico
    function readForm(){
      const options = Array.from($('#f-trabajadores').selectedOptions).map(o=>o.value);
      return {
        id: ($('#f-id').value || genId()).trim(),
        equipo: $('#f-equipo').value.trim(),
        prioridad: $('#f-prioridad').value,
        estado: $('#f-estado').value,
        inicio: $('#f-inicio').value,
        cierre: $('#f-cierre').value,
        titulo: $('#f-titulo').value.trim(),
        desc: $('#f-desc').value.trim(),
        evidencia: $('#f-evidencia').value.trim(),
        trabajadores: options
      };
    }
    function fillForm(ot){
      $('#f-id').value = ot.id || '';
      $('#f-equipo').value = ot.equipo||'';
      $('#f-prioridad').value = ot.prioridad||'Media';
      $('#f-estado').value = ot.estado||'Abierta';
      $('#f-inicio').value = ot.inicio||'';
      $('#f-cierre').value = ot.cierre||'';
      $('#f-titulo').value = ot.titulo||'';
      $('#f-desc').value = ot.desc||'';
      $('#f-evidencia').value = ot.evidencia||'';
      // seleccionar trabajadores
      const sel = $('#f-trabajadores');
      Array.from(sel.options).forEach(o=>o.selected = (ot.trabajadores||[]).includes(o.value));
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function clearForm(){
      $$('input, textarea').forEach(el=>{ if(el.type!=='date') el.value=''; });
      $('#f-inicio').value = ''; $('#f-cierre').value='';
      $('#f-prioridad').value='Media'; $('#f-estado').value='Abierta';
      Array.from($('#f-trabajadores').options).forEach(o=>o.selected=false);
    }

    // ------- Render listado + filtros
    function render(){
      const tbody = $('#tbl tbody');
      const all = loadOTs();
      const q = $('#q').value.toLowerCase();
      const fE = $('#flt-estado').value;
      const fP = $('#flt-prioridad').value;
      const rows = all.filter(o=>{
        const text = (o.id+' '+o.equipo+' '+o.titulo).toLowerCase();
        const okQ = !q || text.includes(q);
        const okE = !fE || o.estado===fE;
        const okP = !fP || o.prioridad===fP;
        return okQ && okE && okP;
      });
      $('#count').textContent = rows.length+' de '+all.length+' OT';
      tbody.innerHTML = '';
      rows.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="#" data-id="${o.id}" class="lnk">${o.id}</a></td>
          <td>${esc(o.titulo)}</td>
          <td>${esc(o.equipo)}</td>
          <td>${esc(o.prioridad)}</td>
          <td class="status ${cls(o.estado)}">${esc(o.estado)}</td>
          <td>${o.inicio||''}</td>
          <td>${o.cierre||''}</td>
          <td>${(o.trabajadores||[]).map(esc).join(', ')}</td>
        `;
        tbody.appendChild(tr);
      });
      // click para editar
      $$('#tbl .lnk').forEach(a=>{
        a.addEventListener('click', e=>{
          e.preventDefault();
          const id = a.dataset.id;
          const ot = loadOTs().find(x=>x.id===id);
          if(ot) fillForm(ot);
        });
      });
    }
    function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);}
    function cls(s){return s.toLowerCase().replace(/\s+/g,'-')}

    // ------- Export CSV
    function exportCSV(){
      const data = loadOTs();
      if(!data.length){ alert('No hay datos para exportar.'); return; }
      const cols = ['id','titulo','equipo','prioridad','estado','inicio','cierre','trabajadores','desc','evidencia'];
      const lines = [cols.join(';')].concat(
        data.map(o=>cols.map(k=>{
          const v = (k==='trabajadores') ? (o[k]||[]).join('|') : (o[k]??'');
          return `"${String(v).replace(/"/g,'""')}"`;
        }).join(';'))
      );
      const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'),{href:url,download:'aurum_ot.csv'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ------- Eventos UI
    $('#btn-save').addEventListener('click', ()=>{
      const form = readForm();
      if(!form.titulo){ alert('Ingresa un t√≠tulo.'); return; }
      let list = loadOTs();
      const idx = list.findIndex(x=>x.id===form.id);
      if(idx>=0) list[idx]=form; else list.unshift(form);
      saveOTs(list);
      fillForm(form); // mantiene edici√≥n
    });
    $('#btn-clear').addEventListener('click', clearForm);
    $('#btn-delete').addEventListener('click', ()=>{
      const id = $('#f-id').value.trim();
      if(!id){ alert('Primero carga una OT para eliminar.'); return; }
      if(!confirm('¬øEliminar la OT '+id+'?')) return;
      let list = loadOTs().filter(x=>x.id!==id);
      saveOTs(list);
      clearForm();
    });

    $('#btn-add-worker').addEventListener('click', ()=>{
      const n = $('#f-nuevo-trabajador').value.trim();
      if(!n){ alert('Escribe un nombre.'); return; }
      const base = loadWorkers();
      if(base.includes(n)){ alert('Ya existe.'); return; }
      base.push(n); saveWorkers(base);
      $('#f-nuevo-trabajador').value='';
    });
    $('#btn-del-worker').addEventListener('click', ()=>{
      const sel = $('#f-trabajadores');
      const v = Array.from(sel.selectedOptions).map(o=>o.value);
      if(!v.length){ alert('Selecciona al menos uno.'); return; }
      const base = loadWorkers().filter(n=>!v.includes(n));
      saveWorkers(base);
    });

    $('#q').addEventListener('input', render);
    $('#flt-estado').addEventListener('change', render);
    $('#flt-prioridad').addEventListener('change', render);
    $('#btn-reset').addEventListener('click', ()=>{
      $('#q').value=''; $('#flt-estado').value=''; $('#flt-prioridad').value='';
      render();
    });
    $('#btn-export').addEventListener('click', exportCSV);

    // ------- Bootstrap inicial
    (function init(){
      // precarga algunos trabajadores de ejemplo si no hay
      if(!localStorage.getItem(LS_KEY_WORKERS)){
        saveWorkers(['Andr√©s Bello','Carla Mu√±oz','Diego Pizarro','Sof√≠a Rojas']);
      } else {
        loadWorkers();
      }
      // ejemplo de OTs iniciales si no hay nada
      if(!loadOTs().length){
        saveOTs([
          {id:'OT-0001', titulo:'Revisi√≥n general 10.000 km', equipo:'Hilux A8-001', prioridad:'Media', estado:'Abierta', inicio:new Date().toISOString().slice(0,10), cierre:'', trabajadores:['Andr√©s Bello'], desc:'Check 50 pts', evidencia:''},
          {id:'OT-0002', titulo:'Cambio pastillas y limpieza', equipo:'Hilux A8-002', prioridad:'Alta', estado:'En progreso', inicio:new Date().toISOString().slice(0,10), cierre:'', trabajadores:['Carla Mu√±oz','Diego Pizarro'], desc:'Eje delantero', evidencia:''}
        ]);
      } else {
        render();
      }
      loadWorkers();
      render();
    })();
  </script>
</body>
</html>