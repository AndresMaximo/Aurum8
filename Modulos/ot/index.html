<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AURUM∞ · Órdenes de Trabajo (OT)</title>
  <link rel="icon" href="../../favicon.ico" />
  <style>
    :root{
      --bg:#041c1f;           /* azul petróleo muy oscuro */
      --panel:#092a2f;        /* panel oscuro */
      --ink:#e8f3f1;          /* texto claro */
      --muted:#9cb6b1;        /* texto tenue */
      --gold:#d4af37;         /* dorado lemuriano */
      --gold-2:#b99527;
      --ok:#1db954;
      --warn:#b37a15;
      --err:#b93838;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:var(--gold);text-decoration:none}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    /* Header */
    header{position:sticky;top:0;z-index:10;background:rgba(4,28,31,.85);backdrop-filter: blur(6px);border-bottom:1px solid rgba(212,175,55,.18)}
    .nav{display:flex;align-items:center;gap:24px;justify-content:space-between;padding:16px 24px}
    .brand{font-weight:800;letter-spacing:.5px;font-size:28px;color:var(--gold)}
    .menu{display:flex;gap:18px;flex-wrap:wrap}
    .menu a{padding:8px 12px;border-radius:999px;color:var(--ink)}
    .menu a:hover{background:rgba(212,175,55,.12);color:var(--gold)}
    /* Cards & form */
    h1{font-size:28px;margin:18px 0}
    h2{font-size:20px;margin:0 0 10px}
    .muted{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:linear-gradient(180deg,var(--panel),#0a3237 120%);padding:18px;border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:8px 0}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0d3a40;color:var(--ink);outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:var(--gold)}
    textarea{min-height:120px;resize:vertical}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-12{grid-column:span 12}
    /* Buttons */
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    .btn{
      border:none;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;
      background:var(--gold);color:#1b1604;box-shadow:0 6px 18px rgba(212,175,55,.25)
    }
    .btn:hover{background:var(--gold-2)}
    .ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.35)}
    .danger{background:var(--err);color:#fff}
    .secondary{background:#114850;color:#e7f7f5}
    .pill{padding:6px 10px;border-radius:999px;border:1px dashed rgba(255,255,255,.25);font-size:12px;color:var(--muted)}
    .table-head{display:grid;grid-template-columns:6fr 2fr 2fr 2fr 40px;gap:8px;font-size:12px;color:var(--muted);margin-top:8px}
    .mat-row{display:grid;grid-template-columns:6fr 2fr 2fr 2fr 40px;gap:8px;margin:6px 0}
    .mini{font-size:12px}
    .right{display:flex;justify-content:flex-end}
    footer{padding:40px 24px;color:var(--muted);text-align:center}
    /* Mobile */
    @media (max-width:800px){
      .row,.table-head,.mat-row{grid-template-columns:1fr}
      .col-6,.col-4,.col-3,.col-12{grid-column:span 12}
      .nav{flex-direction:column;align-items:flex-start;gap:10px}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header>
    <div class="nav">
      <div class="brand">AURUM∞</div>
      <nav class="menu">
        <a href="../../index.html">Inicio</a>
        <a href="../../vision.html">Visión</a>
        <a href="../../modulos.html">Módulos</a>
        <a href="../../contacto.html">Contacto</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Órdenes de Trabajo (OT)</h1>
    <p class="muted">Registra, guarda localmente y exporta tus OT. Más adelante esto se conectará a la base de datos.</p>

    <form id="otForm" class="grid">
      <!-- DATOS GENERALES -->
      <section class="card col-12">
        <h2>Datos generales</h2>
        <div class="row">
          <div class="col-4">
            <label>N° OT</label>
            <input id="otNum" name="otNum" placeholder="OT-YYYYMMDD-HHMM">
          </div>
          <div class="col-4">
            <label>Fecha</label>
            <input type="date" id="fecha" name="fecha" required>
          </div>
          <div class="col-4">
            <label>Estado</label>
            <select id="estado" name="estado">
              <option>Abierta</option>
              <option>En curso</option>
              <option>Cerrada</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <label>Cliente / Unidad</label>
            <input name="cliente" placeholder="Ej: Mina Talcuna">
          </div>
          <div class="col-6">
            <label>Solicitante</label>
            <input name="solicitante" placeholder="Nombre de quien solicita">
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <label>Equipo / Activo</label>
            <input name="equipo" placeholder="Ej: Toyota Hilux 2019 · Patente XXXY11">
          </div>
          <div class="col-3">
            <label>Ubicación</label>
            <input name="ubicacion" placeholder="Planta / Área">
          </div>
          <div class="col-3">
            <label>Prioridad</label>
            <select name="prioridad">
              <option>Baja</option>
              <option>Media</option>
              <option>Alta</option>
              <option>Crítica</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <label>Responsable OT</label>
            <input name="responsable" placeholder="Jefe de mantención">
          </div>
          <div class="col-6">
            <label>Supervisor</label>
            <input name="supervisor" placeholder="Supervisor terreno">
          </div>
        </div>
      </section>

      <!-- DESCRIPCIÓN -->
      <section class="card col-12">
        <h2>Descripción y Alcance</h2>
        <p class="muted mini">Describe claramente el trabajo a realizar, riesgos asociados y medidas de control.</p>
        <textarea name="descripcion" placeholder="Descripción detallada del trabajo…"></textarea>
      </section>

      <!-- FUNCIONARIOS -->
      <section class="card col-12">
        <h2>Funcionarios que Intervienen</h2>
        <p class="muted mini">Registra a todos los trabajadores que participaron en esta OT.</p>

        <div class="row pill col-12">Nombre, RUT, Cargo y Firma (texto o referencia de firma).</div>
        <div id="funcionarios-list">
          <div class="row funcionario">
            <div class="col-6"><input type="text" name="nombre[]" placeholder="Nombre completo" required></div>
            <div class="col-3"><input type="text" name="rut[]" placeholder="RUT" required></div>
            <div class="col-3"><input type="text" name="cargo[]" placeholder="Cargo" required></div>
            <div class="col-12"><input type="text" name="firma[]" placeholder="Firma (texto o enlace a imagen)"></div>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn ghost" onclick="agregarFuncionario()">+ Agregar funcionario</button>
          <button type="button" class="btn secondary" onclick="quitarUltimoFuncionario()">Quitar último</button>
        </div>
      </section>

      <!-- MATERIALES -->
      <section class="card col-12">
        <h2>Materiales e Insumos</h2>
        <div class="table-head">
          <div>Ítem / Descripción</div>
          <div>Cantidad</div>
          <div>Unidad</div>
          <div>Costo</div>
          <div></div>
        </div>
        <div id="mat-list"></div>
        <div class="actions">
          <button type="button" class="btn ghost" onclick="agregarMaterial()">+ Agregar material</button>
          <button type="button" class="btn secondary" onclick="quitarUltimoMaterial()">Quitar último</button>
        </div>
      </section>

      <!-- ADJUNTOS -->
      <section class="card col-12">
        <h2>Evidencias / Adjuntos</h2>
        <p class="muted mini">Imágenes, PDF, informes. (Se guardan en el navegador como referencia, no se suben a servidor)</p>
        <input type="file" id="adjuntos" name="adjuntos" multiple />
      </section>

      <!-- ACCIONES -->
      <section class="card col-12">
        <div class="actions">
          <button type="button" class="btn" onclick="guardarLocal()">Guardar local</button>
          <button type="button" class="btn secondary" onclick="cargarLocal()">Cargar guardado</button>
          <button type="button" class="btn danger" onclick="borrarLocal()">Borrar guardado</button>
          <button type="button" class="btn ghost" onclick="exportarCSV()">Exportar CSV</button>
          <button type="button" class="btn ghost" onclick="window.print()">Imprimir / PDF</button>
          <span class="pill" id="saveStatus">Sin guardar</span>
        </div>
      </section>
    </form>

    <div class="right">
      <a class="pill" href="../../modulos.html">← Volver a Módulos</a>
    </div>
  </main>

  <footer>© 2025 AURUM∞</footer>

  <script>
    // ---------- Helpers ----------
    const LS_KEY = 'aurum-ot';

    function autoOT(){
      const f = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `OT-${f.getFullYear()}${pad(f.getMonth()+1)}${pad(f.getDate())}-${pad(f.getHours())}${pad(f.getMinutes())}`;
    }

    function setStatus(msg){
      const el = document.getElementById('saveStatus');
      el.textContent = msg;
    }

    // ---------- Funcionarios ----------
    function agregarFuncionario(data={}){
      const cont = document.getElementById('funcionarios-list');
      const wrap = document.createElement('div');
      wrap.className = 'row funcionario';
      wrap.innerHTML = `
        <div class="col-6"><input type="text" name="nombre[]" placeholder="Nombre completo" required value="${data.nombre||''}"></div>
        <div class="col-3"><input type="text" name="rut[]" placeholder="RUT" required value="${data.rut||''}"></div>
        <div class="col-3"><input type="text" name="cargo[]" placeholder="Cargo" required value="${data.cargo||''}"></div>
        <div class="col-12"><input type="text" name="firma[]" placeholder="Firma (texto o enlace a imagen)" value="${data.firma||''}"></div>
      `;
      cont.appendChild(wrap);
    }
    function quitarUltimoFuncionario(){
      const cont = document.getElementById('funcionarios-list');
      if(cont.children.length>1){ cont.removeChild(cont.lastElementChild); }
    }

    // ---------- Materiales ----------
    function agregarMaterial(data={}){
      const cont = document.getElementById('mat-list');
      const row = document.createElement('div');
      row.className = 'mat-row';
      row.innerHTML = `
        <input name="mat_item[]" placeholder="Descripción del ítem" value="${data.item||''}">
        <input name="mat_cant[]" type="number" step="any" placeholder="0" value="${data.cant||''}">
        <input name="mat_und[]" placeholder="und, kg, lts…" value="${data.und||''}">
        <input name="mat_costo[]" type="number" step="any" placeholder="0" value="${data.costo||''}">
        <button type="button" class="btn danger" title="Quitar" onclick="this.parentElement.remove()">×</button>
      `;
      cont.appendChild(row);
    }
    function quitarUltimoMaterial(){
      const cont = document.getElementById('mat-list');
      if(cont.children.length>0){ cont.removeChild(cont.lastElementChild); }
    }

    // ---------- Guardar/Cargar ----------
    function getFormData(){
      const f = document.getElementById('otForm');
      const data = {
        otNum: f.otNum.value.trim(),
        fecha: f.fecha.value,
        estado: f.estado.value,
        cliente: f.cliente?.value || '',
        solicitante: f.solicitante?.value || '',
        equipo: f.equipo?.value || '',
        ubicacion: f.ubicacion?.value || '',
        prioridad: f.prioridad?.value || '',
        responsable: f.responsable?.value || '',
        supervisor: f.supervisor?.value || '',
        descripcion: f.descripcion?.value || '',
        funcionarios: [],
        materiales: []
      };
      // funcionarios
      const nombres = [...document.querySelectorAll('input[name="nombre[]"]')];
      const ruts = [...document.querySelectorAll('input[name="rut[]"]')];
      const cargos = [...document.querySelectorAll('input[name="cargo[]"]')];
      const firmas = [...document.querySelectorAll('input[name="firma[]"]')];
      for(let i=0;i<nombres.length;i++){
        data.funcionarios.push({
          nombre: nombres[i].value,
          rut: ruts[i]?.value || '',
          cargo: cargos[i]?.value || '',
          firma: firmas[i]?.value || ''
        });
      }
      // materiales
      const items = [...document.querySelectorAll('input[name="mat_item[]"]')];
      const cants = [...document.querySelectorAll('input[name="mat_cant[]"]')];
      const unds  = [...document.querySelectorAll('input[name="mat_und[]"]')];
      const costos= [...document.querySelectorAll('input[name="mat_costo[]"]')];
      for(let i=0;i<items.length;i++){
        data.materiales.push({
          item: items[i].value,
          cant: cants[i]?.value || '',
          und: unds[i]?.value || '',
          costo: costos[i]?.value || ''
        });
      }
      return data;
    }

    function setFormData(data){
      const f = document.getElementById('otForm');
      f.otNum.value = data.otNum || autoOT();
      f.fecha.value = data.fecha || new Date().toISOString().slice(0,10);
      f.estado.value = data.estado || 'Abierta';
      (f.cliente || {}).value = data.cliente||'';
      (f.solicitante || {}).value = data.solicitante||'';
      (f.equipo || {}).value = data.equipo||'';
      (f.ubicacion || {}).value = data.ubicacion||'';
      (f.prioridad || {}).value = data.prioridad||'Media';
      (f.responsable || {}).value = data.responsable||'';
      (f.supervisor || {}).value = data.supervisor||'';
      (f.descripcion || {}).value = data.descripcion||'';

      // limpiar y reponer funcionarios
      const contF = document.getElementById('funcionarios-list');
      contF.innerHTML = '';
      if(data.funcionarios && data.funcionarios.length){
        data.funcionarios.forEach(agregarFuncionario);
      }else{
        agregarFuncionario();
      }

      // materiales
      const contM = document.getElementById('mat-list');
      contM.innerHTML = '';
      if(data.materiales && data.materiales.length){
        data.materiales.forEach(agregarMaterial);
      }else{
        agregarMaterial();
      }
    }

    function guardarLocal(){
      const data = getFormData();
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      setStatus('Guardado local ✓');
    }
    function cargarLocal(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ setStatus('No hay guardado'); return; }
      const data = JSON.parse(raw);
      setFormData(data);
      setStatus('Cargado desde local');
    }
    function borrarLocal(){
      localStorage.removeItem(LS_KEY);
      setStatus('Guardado eliminado');
    }

    // ---------- Exportar ----------
    function exportarCSV(){
      const d = getFormData();
      let lines = [];
      lines.push('Campo,Valor');
      const basics = ['otNum','fecha','estado','cliente','solicitante','equipo','ubicacion','prioridad','responsable','supervisor'];
      basics.forEach(k => lines.push(`${k},"${(d[k]||'').toString().replace(/"/g,'""')}"`));
      lines.push(`descripcion,"${(d.descripcion||'').replace(/"/g,'""')}"`);
      // funcionarios
      lines.push('');
      lines.push('Funcionarios:');
      lines.push('Nombre,RUT,Cargo,Firma');
      d.funcionarios.forEach(f => lines.push(`"${f.nombre.replace(/"/g,'""')}","${(f.rut||'').replace(/"/g,'""')}","${(f.cargo||'').replace(/"/g,'""')}","${(f.firma||'').replace(/"/g,'""')}"`));
      // materiales
      lines.push('');
      lines.push('Materiales:');
      lines.push('Item,Cantidad,Unidad,Costo');
      d.materiales.forEach(m => lines.push(`"${(m.item||'').replace(/"/g,'""')}",${m.cant||''},"${m.und||''}",${m.costo||''}`));

      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${d.otNum||'OT'}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Init ----------
    (function init(){
      // Autocompletar número y fecha
      const n = document.getElementById('otNum');
      if(!n.value) n.value = autoOT();
      const f = document.getElementById('fecha');
      if(!f.value) f.value = new Date().toISOString().slice(0,10);
      // Primer material por defecto
      agregarMaterial();
    })();
  </script>
</body>
</html>