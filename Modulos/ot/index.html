<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√ìrdenes de Trabajo ‚Ä¢ AURUM‚àû</title>
  <style>
    :root{
      --bg:#0b0b0b; --ink:#e0e0e0; --gold:#ffb400;
      --panel:#141414; --muted:#9aa3af; --line:#2a2a2a; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:var(--gold);text-decoration:none}
    header.top{
      position:sticky;top:0;background:rgba(11,11,11,.85);backdrop-filter:blur(6px);
      border-bottom:1px solid var(--line);z-index:10
    }
    header.top .wrap{max-width:1100px;margin:auto;display:flex;gap:16px;align-items:center;padding:12px 16px}
    h1{font-size:22px;margin:0}
    main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;gap:24px}
    .card{background:linear-gradient(180deg,#0f0f0f, #0b0b0b);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px 0;padding:0;font-size:18px}
    .pad{padding:16px}
    .grid{display:grid;gap:12px}
    .grid.col2{grid-template-columns:1fr 1fr}
    .grid.col3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:820px){.grid.col2,.grid.col3{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:#0e0e0e;color:var(--ink);outline:none
    }
    textarea{min-height:84px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;border:none;border-radius:999px;padding:10px 16px;font-weight:600}
    .btn.gold{background:var(--gold);color:#1a1a1a}
    .btn.ghost{background:#111;border:1px solid var(--line);color:var(--ink)}
    .btn.red{background:var(--bad)}
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    .tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);gap:8px}
    .tag.ok{border-color:#14532d;color:#22c55e}
    .tag.warn{border-color:#713f12;color:#f59e0b}
    .tag.bad{border-color:#7f1d1d;color:#ef4444}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
    th{color:#cbd5e1;text-align:left}
    .muted{color:var(--muted)}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#121212}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header class="top">
    <div class="wrap">
      <h1>√ìrdenes de Trabajo</h1>
      <div class="muted" style="margin-left:auto">AURUM‚àû</div>
      <a class="pill" href="/modulos.html">‚Üê Volver a M√≥dulos</a>
    </div>
  </header>

  <main>
    <!-- Crear OT -->
    <section class="card">
      <div class="pad">
        <div class="toolbar">
          <h2>Crear nueva OT</h2>
          <div class="muted">Completa los datos y asigna trabajadores</div>
        </div>
        <form id="form-ot" class="grid col3">
          <div>
            <label>Equipo</label>
            <input id="equipo" placeholder="Ej: Hilux DXJ-123" required />
          </div>
          <div>
            <label>Tipo</label>
            <select id="tipo" required>
              <option value="preventiva">Preventiva</option>
              <option value="correctiva">Correctiva</option>
              <option value="inspecci√≥n">Inspecci√≥n</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div>
            <label>Estado</label>
            <select id="estado" required>
              <option value="pendiente" selected>Pendiente</option>
              <option value="en_progreso">En progreso</option>
              <option value="completada">Completada</option>
            </select>
          </div>

          <div>
            <label>Fecha inicio</label>
            <input id="fecha_inicio" type="datetime-local" />
          </div>
          <div>
            <label>Fecha fin (opcional)</label>
            <input id="fecha_fin" type="datetime-local" />
          </div>
          <div>
            <label>Funci√≥n / comentario (para el equipo asignado)</label>
            <input id="funcion" placeholder="Ej: Soldadura, inspecci√≥n visual, etc." />
          </div>

          <div class="colspan" style="grid-column:1/-1">
            <label>Asignar trabajadores</label>
            <select id="trabajadores" multiple size="6" style="width:100%"></select>
            <div class="muted" style="margin-top:6px">Mant√©n presionado Ctrl (o Cmd) para selecci√≥n m√∫ltiple</div>
          </div>

          <div class="row" style="grid-column:1/-1;justify-content:flex-end;margin-top:6px">
            <button type="button" class="btn ghost" id="limpiar">Limpiar</button>
            <button type="submit" class="btn gold">Crear OT</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Listado OTs -->
    <section class="card">
      <div class="pad">
        <div class="toolbar">
          <h2>Listado de OTs</h2>
          <button class="btn ghost" id="refrescar">Refrescar</button>
        </div>

        <table id="tabla-ots">
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th class="nowrap">Inicio</th>
              <th class="nowrap">Fin</th>
              <th>Trabajadores</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="body-ots">
            <!-- filas din√°micas -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;

    // üîê Reemplaza con tus credenciales
    const SUPABASE_URL = "https://TU-PROYECTO.supabase.co";
    const SUPABASE_ANON_KEY = "TU-ANON-PUBLIC-KEY";
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Utilidades
    const fmtDate = (v) => v ? new Date(v).toLocaleString() : "‚Äî";
    const tagEstado = (estado) => {
      const map = {
        pendiente: 'tag warn',
        en_progreso: 'tag',
        completada: 'tag ok'
      };
      return `<span class="${map[estado] || 'tag'}">${estado.replace('_',' ')}</span>`;
    };

    // Cargar trabajadores al <select>
    async function cargarTrabajadoresSelect() {
      const sel = document.getElementById('trabajadores');
      sel.innerHTML = '<option disabled>Cargando‚Ä¶</option>';

      const { data, error } = await db.from('recursos_humanos').select('id,nombre').order('nombre');
      if (error) { console.error(error); sel.innerHTML = ''; return; }

      sel.innerHTML = '';
      data.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.nombre;
        sel.appendChild(opt);
      });
    }

    // Crear OT
    document.getElementById('form-ot').addEventListener('submit', async (e) => {
      e.preventDefault();
      const equipo = document.getElementById('equipo').value.trim();
      const tipo = document.getElementById('tipo').value;
      const estado = document.getElementById('estado').value;
      const funcion = document.getElementById('funcion').value.trim();

      const fi = document.getElementById('fecha_inicio').value;
      const ff = document.getElementById('fecha_fin').value || null;

      // Insert OT
      const { data: nuevaOT, error: errOT } = await db
        .from('ordenes_trabajo')
        .insert([{
          equipo, tipo, estado,
          fecha_inicio: fi ? new Date(fi).toISOString() : null,
          fecha_fin: ff ? new Date(ff).toISOString() : null
        }])
        .select()
        .single();

      if (errOT) { alert('Error creando OT: ' + errOT.message); return; }

      // Asignaciones
      const sel = document.getElementById('trabajadores');
      const seleccion = Array.from(sel.selectedOptions).map(o => o.value);

      if (seleccion.length) {
        const payload = seleccion.map(trabajador_id => ({
          ot_id: nuevaOT.id,
          trabajador_id,
          funcion: funcion || null
        }));
        const { error: errAsign } = await db.from('ot_trabajadores').insert(payload);
        if (errAsign) { alert('OT creada pero error asignando trabajadores: ' + errAsign.message); }
      }

      alert('‚úÖ OT creada con √©xito');
      e.target.reset();
      cargarOTs();
    });

    document.getElementById('limpiar').addEventListener('click', () => {
      document.getElementById('form-ot').reset();
    });

    document.getElementById('refrescar').addEventListener('click', cargarOTs);

    // Listar OTs
    async function cargarOTs() {
      const tbody = document.getElementById('body-ots');
      tbody.innerHTML = '<tr><td class="muted" colspan="7">Cargando‚Ä¶</td></tr>';

      const [{ data: ots, error: e1 }, { data: relaciones, error: e2 }, { data: rh, error: e3 }] = await Promise.all([
        db.from('ordenes_trabajo').select('*').order('fecha_inicio',{ascending:false}),
        db.from('ot_trabajadores').select('ot_id, trabajador_id, funcion'),
        db.from('recursos_humanos').select('id,nombre')
      ]);

      if (e1 || e2 || e3) {
        console.error(e1 || e2 || e3);
        tbody.innerHTML = '<tr><td class="muted" colspan="7">Error cargando datos</td></tr>';
        return;
      }

      const nombrePorId = new Map(rh.map(x => [x.id, x.nombre]));
      const asignPorOT = new Map();
      relaciones.forEach(r => {
        if (!asignPorOT.has(r.ot_id)) asignPorOT.set(r.ot_id, []);
        asignPorOT.get(r.ot_id).push({ id: r.trabajador_id, nombre: nombrePorId.get(r.trabajador_id) || '‚Äî', funcion: r.funcion });
      });

      tbody.innerHTML = '';
      if (!ots.length) {
        tbody.innerHTML = '<tr><td class="muted" colspan="7">No hay OTs registradas.</td></tr>';
        return;
      }

      for (const ot of ots) {
        const asign = asignPorOT.get(ot.id) || [];
        const nombres = asign.map(a => a.nombre).join(', ') || '‚Äî';

        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${ot.equipo}</td>
          <td>${ot.tipo}</td>
          <td>${tagEstado(ot.estado)}</td>
          <td class="nowrap">${fmtDate(ot.fecha_inicio)}</td>
          <td class="nowrap">${fmtDate(ot.fecha_fin)}</td>
          <td>${nombres}</td>
          <td class="nowrap">
            <select data-accion="estado" data-id="${ot.id}">
              <option value="pendiente" ${ot.estado==='pendiente'?'selected':''}>Pendiente</option>
              <option value="en_progreso" ${ot.estado==='en_progreso'?'selected':''}>En progreso</option>
              <option value="completada" ${ot.estado==='completada'?'selected':''}>Completada</option>
            </select>
            <button class="btn red" data-accion="borrar" data-id="${ot.id}" style="margin-left:6px">Borrar</button>
          </td>
        `;
        tbody.appendChild(fila);
      }

      // Delegaci√≥n de eventos (cambiar estado / borrar)
      tbody.querySelectorAll('select[data-accion="estado"]').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const nuevo = e.target.value;
          const { error } = await db.from('ordenes_trabajo').update({ estado: nuevo }).eq('id', id);
          if (error) { alert('Error al actualizar estado: ' + error.message); }
          else { cargarOTs(); }
        });
      });
      tbody.querySelectorAll('button[data-accion="borrar"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('¬øBorrar OT y sus asignaciones?')) return;
          const id = btn.dataset.id;
          const { error } = await db.from('ordenes_trabajo').delete().eq('id', id);
          if (error) { alert('No se pudo borrar: ' + error.message); }
          else { cargarOTs(); }
        });
      });
    }

    // Inicializaci√≥n
    (async function init(){
      await cargarTrabajadoresSelect();
      await cargarOTs();
    })();
  </script>
</body>
</html>