<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AURUM∞ · Iniciar sesión</title>
  <link rel="stylesheet" href="/aurum-theme.css" />
  <style>
    body{margin:0;background:#000;color:#d8f3dc;font-family:Orbitron,system-ui,Segoe UI,Roboto,Arial}
    main{max-width:980px;margin:40px auto;padding:0 20px}
    .card{background:#0b0f12;border:1px solid #16332f;border-radius:16px;padding:24px}
    .row{display:grid;gap:14px}
    @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    label{font-size:.9rem;opacity:.85}
    input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid #24423c;background:#0a1513;color:#d8f3dc}
    button{padding:12px 16px;border-radius:12px;border:0;background:#00f5d4;color:#001510;
      font-weight:700;cursor:pointer}
    .muted{opacity:.7}
    .error{color:#ff6b6b;margin-top:8px}
    .ok{color:#00f5d4;margin-top:8px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    a.btn{display:inline-block;padding:12px 16px;border-radius:12px;border:1px solid #24423c;text-decoration:none;color:#b7efe4}
  </style>
</head>
<body>
  <main>
    <h1>Acceso a AURUM∞</h1>
    <div class="card">
      <div class="row">
        <div>
          <h2>Ingresar</h2>
          <label>Email</label>
          <input id="email" type="email" placeholder="tucorreo@empresa.com" autocomplete="username" />
          <label>Contraseña</label>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
          <div class="actions" style="margin-top:10px">
            <button id="btn-login">Entrar</button>
            <a class="btn" href="/modulos.html">Volver</a>
          </div>
          <div id="msg" class="muted"></div>
        </div>

        <div>
          <h2>Primera vez</h2>
          <p class="muted">Si nunca te han creado usuario, regístrate aquí. Un administrador aprobará tu rol.</p>
          <label>Email</label>
          <input id="signup-email" type="email" placeholder="tucorreo@empresa.com" autocomplete="email" />
          <label>Contraseña</label>
          <input id="signup-pass" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />
          <div class="actions" style="margin-top:10px">
            <button id="btn-signup">Crear cuenta</button>
          </div>
          <div id="msg-signup" class="muted"></div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { supabase } from '/js/supabaseClient.js';

    const email = document.querySelector('#email');
    const pass  = document.querySelector('#password');
    const msg   = document.querySelector('#msg');

    const sEmail = document.querySelector('#signup-email');
    const sPass  = document.querySelector('#signup-pass');
    const sMsg   = document.querySelector('#msg-signup');

    // LOGIN
    document.querySelector('#btn-login').addEventListener('click', async () => {
      msg.textContent = 'Conectando...';
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value.trim(),
        password: pass.value
      });
      if (error) { msg.textContent = ''; msg.className='error'; msg.textContent = 'Error: ' + error.message; return; }

      // mira tu perfil para decidir adónde redirigir
      const { data: perfil } = await supabase
        .from('perfiles')
        .select('role, full_name')
        .eq('id', data.user.id)
        .maybeSingle();

      msg.className='ok';
      msg.textContent = 'Listo. Redirigiendo...';
      // admin → admin usuarios, si no → módulos
      if (perfil?.role === 'admin') {
        location.href = '/modulos/admin-usuarios/index.html';
      } else {
        location.href = '/modulos.html';
      }
    });

    // SIGNUP
    document.querySelector('#btn-signup').addEventListener('click', async () => {
      sMsg.textContent = 'Creando...';
      const { data, error } = await supabase.auth.signUp({
        email: sEmail.value.trim(),
        password: sPass.value
      });
      if (error) { sMsg.className='error'; sMsg.textContent='Error: '+error.message; return; }

      // crea registro en perfiles como "viewer" por defecto
      const user = data.user;
      if (user) {
        await supabase.from('perfiles').upsert({
          id: user.id,
          email: user.email,
          full_name: user.email,
          role: 'viewer'
        });
      }
      sMsg.className='ok';
      sMsg.textContent = 'Cuenta creada. Revisa tu correo si se exige confirmación.';
    });
  </script>
</body>
</html>