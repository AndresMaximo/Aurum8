<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Órdenes de Trabajo · AURUM∞</title>
<link rel="stylesheet" href="/aurum-theme.css">
<link rel="stylesheet" href="/common/topbar.css">
<style>
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#0b0f12;border:1px solid #1e2b33;border-radius:16px;padding:16px;margin-bottom:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #1e2b33}
  .btn{background:#00f5d4;border:0;padding:10px 14px;border-radius:10px;color:#001313;cursor:pointer}
  .muted{opacity:.7}
  @media (max-width:820px){.grid2{grid-template-columns:1fr}.row{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<div id="topbar"></div>

<main class="wrap">
  <h1>Órdenes de Trabajo</h1>
  <p class="muted">Estado de conexión: <b data-conn>—</b></p>

  <section class="card grid2">
    <div>
      <label>Seleccionar OT</label>
      <select id="sel-ot"></select>
    </div>
    <div>
      <label>Estado (solo lectura)</label>
      <input id="estado-ot" disabled placeholder="pendiente / en_progreso"/>
    </div>
    <div class="muted">Equipo: <span id="lbl-equipo">—</span></div>
    <div class="muted" style="text-align:right">Inicio: <span id="lbl-inicio">—</span></div>
  </section>

  <section class="card">
    <h2>Responsables / Personal en la OT</h2>
    <div class="row" style="align-items:end">
      <div>
        <label>Trabajador</label>
        <select id="sel-trabajador"></select>
      </div>
      <div>
        <label>Función</label>
        <input id="input-funcion" placeholder="Ej: Mecánico, Supervisor"/>
      </div>
      <div style="grid-column: span 2; text-align:right">
        <button id="btn-asignar-ot" class="btn">Asignar a la OT</button>
      </div>
    </div>

    <table id="tabla-resp">
      <thead><tr><th>Trabajador</th><th>Función</th><th>Acción</th></tr></thead>
      <tbody><tr><td colspan="3">—</td></tr></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Registrar consumo de repuesto</h2>
    <form id="form-consumo" class="row" style="grid-template-columns:1fr 2fr 1fr auto">
      <input name="sku" placeholder="SKU" required/>
      <input name="nombre" placeholder="Nombre / Descripción"/>
      <input name="cantidad" type="number" min="1" placeholder="Cantidad" required/>
      <button class="btn">Registrar consumo</button>
    </form>
    <table id="tabla-consumos">
      <thead><tr><th>SKU</th><th>Nombre</th><th>Cantidad</th><th>Trabajador</th></tr></thead>
      <tbody><tr><td colspan="4">—</td></tr></tbody>
    </table>
  </section>
</main>

<script>fetch('/common/topbar.html').then(r=>r.text()).then(t=>document.getElementById('topbar').innerHTML=t)</script>
<script type="module" src="/supabaseClient.js"></script>
<script type="module" src="/aurum-data.js"></script>
<script type="module">
  import {
    listarOTs, listarTrabajadores,
    asignarTrabajadorAOT, registrarConsumo,
    pintarEstadoConexion
  } from "/aurum-data.js";

  pintarEstadoConexion();

  const selOT = document.getElementById("sel-ot");
  const selTrab = document.getElementById("sel-trabajador");
  const inputFuncion = document.getElementById("input-funcion");
  const lblEquipo = document.getElementById("lbl-equipo");
  const lblInicio = document.getElementById("lbl-inicio");
  const estadoOT = document.getElementById("estado-ot");

  // ===== Carga de datos en selects =====
  async function cargarOTs(){
    const ots = await listarOTs();
    selOT.innerHTML = `<option value="">Seleccionar OT</option>` +
      ots.map(o => `<option value="${o.id}" data-equipo="${o.equipo??""}" data-estado="${o.estado??""}" data-inicio="${o.fecha_inicio??""}">
        ${o.equipo??"Equipo"} · ${o.tipo??""}
      </option>`).join("");
  }

  async function cargarTrabajadores(){
    const lista = await listarTrabajadores();
    selTrab.innerHTML = `<option value="">Seleccionar trabajador</option>` +
      lista.map(t => `<option value="${t.id}">${t.nombre}</option>`).join("");
  }

  selOT.addEventListener("change", ()=>{
    const opt = selOT.selectedOptions[0];
    lblEquipo.textContent = opt?.dataset.equipo || "—";
    lblInicio.textContent = (opt?.dataset.inicio || "—").toString().slice(0,10);
    estadoOT.value = opt?.dataset.estado || "";
  });

  // ===== Asignar responsable =====
  document.getElementById("btn-asignar-ot").addEventListener("click", async ()=>{
    const ot_id = selOT.value;
    const trabajador_id = selTrab.value;
    const funcion = (inputFuncion.value || "").trim();
    if(!ot_id || !trabajador_id || !funcion){ alert("Selecciona OT, trabajador y función"); return; }
    try{
      await asignarTrabajadorAOT(ot_id, trabajador_id, funcion);
      alert("Asignado correctamente");
    }catch(e){ console.error(e); alert("Error al asignar"); }
  });

  // ===== Registrar consumo =====
  document.getElementById("form-consumo").addEventListener("submit", async ev=>{
    ev.preventDefault();
    const fd = new FormData(ev.currentTarget);
    const payload = {
      ot_id: selOT.value || null,
      sku: fd.get("sku")?.trim() || null,
      nombre: fd.get("nombre")?.trim() || null,
      cantidad: Number(fd.get("cantidad") || 0),
      trabajador_id: selTrab.value || null
    };
    if(!payload.ot_id || !payload.sku || !payload.cantidad){ alert("OT, SKU y cantidad son obligatorios"); return; }
    try{
      await registrarConsumo(payload);
      ev.currentTarget.reset();
      alert("Consumo registrado");
    }catch(e){ console.error(e); alert("Error al registrar"); }
  });

  // Primera carga
  await cargarOTs();
  await cargarTrabajadores();
</script>
</body>
</html>