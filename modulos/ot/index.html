<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Órdenes de Trabajo · AURUM∞</title>
<link rel="stylesheet" href="/aurum-theme.css">
<link rel="stylesheet" href="/common/topbar.css">
<style>
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#0b0f12;border:1px solid #1e2b33;border-radius:16px;padding:16px;margin-bottom:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #1e2b33}
  .btn{background:#00f5d4;border:0;padding:10px 14px;border-radius:10px;color:#001313;cursor:pointer}
  .muted{opacity:.7}
  /* Evita solapes en móvil */
  @media (max-width:820px){
    .grid2{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div id="topbar"></div>

<main class="wrap">
  <h1>Órdenes de Trabajo</h1>
  <p class="muted">Estado de conexión: <b data-conn>—</b></p>

  <section class="card grid2">
    <div>
      <label>Seleccionar OT</label>
      <select id="sel-ot"></select>
    </div>
    <div>
      <label>Estado (solo lectura)</label>
      <input id="estado-ot" disabled placeholder="pendiente / en_progreso"/>
    </div>
    <div class="muted">Equipo: <span id="lbl-equipo">—</span></div>
    <div class="muted" style="text-align:right">Inicio: <span id="lbl-inicio">—</span></div>
  </section>

  <section class="card">
    <h2>Responsables / Personal en la OT</h2>
    <div class="row" style="align-items:end">
      <div>
        <label>Trabajador</label>
        <select id="sel-trabajador"></select>
      </div>
      <div>
        <label>Función</label>
        <input id="input-funcion" placeholder="Ej: Mecánico, Supervisor"/>
      </div>
      <div style="text-align:right">
        <button id="btn-asignar-ot" class="btn">Asignar a la OT</button>
      </div>
    </div>

    <table id="tabla-resp">
      <thead><tr><th>Trabajador</th><th>Función</th><th>Acción</th></tr></thead>
      <tbody><tr><td colspan="3">—</td></tr></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Registrar consumo de repuesto</h2>
    <form id="form-consumo" class="row" style="grid-template-columns:1fr 2fr 1fr auto">
      <input name="sku" placeholder="SKU" required/>
      <input name="nombre" placeholder="Nombre / Descripción"/>
      <input name="cantidad" type="number" min="1" placeholder="Cantidad" required/>
      <button class="btn">Registrar consumo</button>
    </form>
    <table id="tabla-consumos">
      <thead><tr><th>SKU</th><th>Nombre</th><th>Cantidad</th><th>Trabajador</th></tr></thead>
      <tbody><tr><td colspan="4">—</td></tr></tbody>
    </table>
  </section>
</main>

<script>
  // Topbar común
  fetch('/common/topbar.html').then(r=>r.text()).then(t=>document.getElementById('topbar').innerHTML=t)
</script>

<script type="module" src="/supabaseClient.js"></script>
<script type="module" src="/aurum-data.js"></script>
<script type="module">
  import {
    listarOTs, listarTrabajadores, listarAsignados,
    asignarTrabajadorAOT, eliminarAsignacion,
    registrarConsumo, listarConsumos,
    pintarEstadoConexion
  } from "/aurum-data.js";

  pintarEstadoConexion();

  const selOT = document.getElementById("sel-ot");
  const selTrab = document.getElementById("sel-trabajador");
  const inputFuncion = document.getElementById("input-funcion");
  const lblEquipo = document.getElementById("lbl-equipo");
  const lblInicio = document.getElementById("lbl-inicio");
  const estadoOT = document.getElementById("estado-ot");
  const tbodyResp = document.querySelector("#tabla-resp tbody");
  const tbodyCons = document.querySelector("#tabla-consumos tbody");

  async function cargarOTs(){
    const ots = await listarOTs();
    selOT.innerHTML = `<option value="">Seleccionar OT</option>` +
      (ots||[]).map(o => `<option value="${o.id}" data-equipo="${o.equipo??""}" data-estado="${o.estado??""}" data-inicio="${o.fecha_inicio??""}">
        ${o.equipo??"Equipo"} · ${o.tipo??""}
      </option>`).join("");
  }

  async function cargarTrabajadores(){
    const lista = await listarTrabajadores();
    selTrab.innerHTML = `<option value="">Seleccionar trabajador</option>` +
      (lista||[]).map(t => `<option value="${t.id}">${t.nombre}</option>`).join("");
  }

  async function cargarAsignadosYConsumos(){
    const ot_id = selOT.value;
    // asignados
    const asig = ot_id ? await listarAsignados(ot_id) : [];
    tbodyResp.innerHTML = asig.length ? "" : `<tr><td colspan="3">—</td></tr>`;
    asig.forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.trabajador_nombre||'—'}</td><td>${a.funcion||'—'}</td>
      <td><button data-id="${a.id}" class="btn btn-del" style="background:#182429;color:#d8f3dc">Quitar</button></td>`;
      tbodyResp.appendChild(tr);
    });
    tbodyResp.querySelectorAll('.btn-del').forEach(b=>{
      b.addEventListener('click', async ()=>{
        await eliminarAsignacion(b.dataset.id);
        await cargarAsignadosYConsumos();
      });
    });

    // consumos
    const cons = ot_id ? await listarConsumos(ot_id) : [];
    tbodyCons.innerHTML = cons.length ? "" : `<tr><td colspan="4">—</td></tr>`;
    cons.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.sku||'—'}</td><td>${c.nombre||'—'}</td><td>${c.cantidad||0}</td><td>${c.trabajador_nombre||'—'}</td>`;
      tbodyCons.appendChild(tr);
    });
  }

  selOT.addEventListener("change", async ()=>{
    const opt = selOT.selectedOptions[0];
    lblEquipo.textContent = opt?.dataset.equipo || "—";
    lblInicio.textContent = (opt?.dataset.inicio || "—").toString().slice(0,10);
    estadoOT.value = opt?.dataset.estado || "";
    await cargarAsignadosYConsumos();
  });

  document.getElementById("btn-asignar-ot").addEventListener("click", async ()=>{
    const ot_id = selOT.value;
    const trabajador_id = selTrab.value;
    const funcion = (inputFuncion.value || "").trim();
    if(!ot_id || !trabajador_id || !funcion){ alert("Selecciona OT, trabajador y función"); return; }
    await asignarTrabajadorAOT(ot_id, trabajador_id, funcion);
    inputFuncion.value = "";
    await cargarAsignadosYConsumos();
    alert("Asignado correctamente");
  });

  document.getElementById("form-consumo").addEventListener("submit", async ev=>{
    ev.preventDefault();
    const fd = new FormData(ev.currentTarget);
    const payload = {
      ot_id: selOT.value || null,
      sku: (fd.get("sku")||"").trim(),
      nombre: (fd.get("nombre")||"").trim(),
      cantidad: Number(fd.get("cantidad")||0),
      trabajador_id: selTrab.value || null
    };
    if(!payload.ot_id || !payload.sku || !payload.cantidad){ alert("OT, SKU y cantidad son obligatorios"); return; }
    await registrarConsumo(payload);
    ev.currentTarget.reset();
    await cargarAsignadosYConsumos();
    alert("Consumo registrado");
  });

  await cargarOTs();
  await cargarTrabajadores();
</script>
</body>
</html>