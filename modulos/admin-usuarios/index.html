<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AURUM∞ · Administración de Usuarios</title>
  <link rel="stylesheet" href="/aurum-theme.css">
  <style>
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#0a0f12;border:1px solid rgba(0,255,200,.18);border-radius:16px;padding:18px;margin-bottom:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block;margin-bottom:6px;opacity:.9}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c1418;color:#d8f3dc}
    input::placeholder{opacity:.6}
    .btn{background:#00f5d4;color:#042; font-weight:700;border:none;cursor:pointer}
    .btn.secondary{background:#182429;color:#d8f3dc;border:1px solid rgba(255,255,255,.14)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{text-align:left;opacity:.8}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .muted{opacity:.7}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(0,255,200,.12);border:1px solid rgba(0,255,200,.25)}
    .warn{color:#ffd166}
    .ok{color:#00f5d4}
    .error{color:#ff6b6b}
  </style>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="/index.html">AURUM∞</a>
    <button id="hamb" aria-label="Menú" class="hamb"></button>
    <nav id="menu" class="menu">
      <a href="/modulos.html">Módulos</a>
      <a href="/modulos/ot/index.html">Órdenes</a>
      <a href="/modulos/bodega/index.html">Bodega</a>
      <a href="/modulos/recursos-humanos/index.html">RR.HH.</a>
      <a href="/modulos/admin/index.html" class="active">Admin</a>
    </nav>
  </header>

  <main>
    <h1>Administración de Usuarios</h1>
    <p id="guard" class="muted">Solo perfiles con rol <span class="pill">admin</span> pueden administrar.</p>

    <!-- Estado de conexión / usuario -->
    <div class="card">
      <div class="row">
        <div>
          <label>Sesión</label>
          <div id="sesion" class="muted">—</div>
        </div>
        <div>
          <label>Rol actual</label>
          <div id="rolActual" class="muted">—</div>
        </div>
        <div class="right" style="align-items:flex-end">
          <button id="btnLogin" class="btn secondary">Iniciar sesión</button>
          <button id="btnLogout" class="btn secondary" style="display:none">Cerrar sesión</button>
        </div>
      </div>
    </div>

    <!-- Alta/Edición rápida -->
    <div class="card" id="boxEditor" style="display:none">
      <h3>Crear / Actualizar perfil</h3>
      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="usuario@empresa.com" />
        </div>
        <div>
          <label for="nombre">Nombre</label>
          <input id="nombre" type="text" placeholder="Nombre y Apellido" />
        </div>
        <div>
          <label for="rol">Rol</label>
          <select id="rol">
            <option value="viewer">viewer</option>
            <option value="operador">operador</option>
            <option value="supervisor">supervisor</option>
            <option value="admin">admin</option>
          </select>
        </div>
      </div>
      <div class="right" style="margin-top:10px">
        <button id="btnGuardar" class="btn">Guardar</button>
      </div>
      <p class="muted" style="margin-top:8px">
        Consejo: puedes precargar a tus usuarios aquí. Cuando inicien sesión por primera vez, ya tendrán rol.
      </p>
      <div id="msgEditor" class="muted"></div>
    </div>

    <!-- Listado -->
    <div class="card" id="boxTabla" style="display:none">
      <div class="row" style="align-items:center">
        <h3 style="margin:0;flex:1">Perfiles</h3>
        <button id="btnRefresh" class="btn secondary" style="width:auto">Actualizar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Nombre</th>
            <th>Rol</th>
            <th>Creado</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="msgTabla" class="muted"></div>
    </div>

    <div id="soloLectura" class="card" style="display:none">
      <span class="warn">Tu rol no es admin.</span>
      <p>Si necesitas permisos, solicita a un administrador que te asigne <b>admin</b> en <code>perfiles</code>.</p>
    </div>
  </main>

  <script src="/superbaseClient.js"></script>
  <script>
    // ===== UI mínimos (hamburguesa)
    const hamb = document.getElementById('hamb');
    const menu = document.getElementById('menu');
    hamb.addEventListener('click', ()=> menu.classList.toggle('open'));

    // ===== Supabase helpers
    const sesion = document.getElementById('sesion');
    const rolActual = document.getElementById('rolActual');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    const boxEditor = document.getElementById('boxEditor');
    const boxTabla  = document.getElementById('boxTabla');
    const soloLectura = document.getElementById('soloLectura');

    const email = document.getElementById('email');
    const nombre = document.getElementById('nombre');
    const rol = document.getElementById('rol');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnRefresh = document.getElementById('btnRefresh');
    const tbody = document.getElementById('tbody');
    const msgEditor = document.getElementById('msgEditor');
    const msgTabla = document.getElementById('msgTabla');

    let user = null;
    let rolUser = null;

    // ---- Autenticación básica (email link)
    btnLogin.onclick = async ()=>{
      const correo = prompt('Ingresa tu email para recibir un enlace de acceso:');
      if(!correo) return;
      const { error } = await supabase.auth.signInWithOtp({ email: correo, options:{ emailRedirectTo: window.location.origin + '/modulos/admin/index.html' }});
      alert(error ? ('Error: '+error.message) : 'Te enviamos un enlace a tu correo.');
    };
    btnLogout.onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };

    // ---- Carga de sesión + role check
    init();
    async function init(){
      const { data:{ user: U } } = await supabase.auth.getUser();
      user = U || null;

      sesion.textContent = user ? (user.email || user.id) : 'Sin sesión';
      btnLogin.style.display  = user ? 'none' : 'inline-block';
      btnLogout.style.display = user ? 'inline-block' : 'none';

      // Obtiene rol desde tabla perfiles (por id o por email)
      rolUser = await getRoleFor(user);
      rolActual.innerHTML = rolUser ? `<span class="pill">${rolUser}</span>` : '—';

      if(rolUser === 'admin'){
        boxEditor.style.display = '';
        boxTabla.style.display = '';
        soloLectura.style.display = 'none';
        await cargarTabla();
      }else{
        boxEditor.style.display = 'none';
        boxTabla.style.display = 'none';
        soloLectura.style.display = '';
      }
    }

    async function getRoleFor(U){
      if(!U) return null;
      // 1) por id
      let { data:r1 } = await supabase
        .from('perfiles')
        .select('role')
        .eq('id', U.id)
        .maybeSingle();
      if(r1?.role) return r1.role;

      // 2) por email (por si precargaste antes de que el usuario exista en auth)
      if(U.email){
        let { data:r2 } = await supabase
          .from('perfiles')
          .select('role')
          .eq('email', U.email)
          .maybeSingle();
        if(r2?.role) return r2.role;
      }
      return null;
    }

    // ---- CRUD Perfiles
    btnGuardar.onclick = async ()=>{
      msgEditor.textContent = '';
      const payload = {
        email: (email.value||'').trim().toLowerCase(),
        full_name: (nombre.value||'').trim(),
        role: rol.value
      };
      if(!payload.email){ msgEditor.textContent = 'Email es obligatorio.'; return; }

      // Si ya existe una fila por email, actualiza; si existe el user en auth, luego podrás setear id manualmente.
      const { error } = await supabase
        .from('perfiles')
        .upsert(payload, { onConflict: 'email' });
      if(error){ msgEditor.innerHTML = `<span class="error">Error: ${error.message}</span>`; return; }
      msgEditor.innerHTML = `<span class="ok">Guardado.</span>`;
      email.value = nombre.value = '';
      rol.value = 'viewer';
      await cargarTabla();
    };

    btnRefresh.onclick = ()=> cargarTabla();

    async function cargarTabla(){
      msgTabla.textContent = '';
      tbody.innerHTML = '<tr><td class="muted" colspan="5">Cargando…</td></tr>';
      const { data, error } = await supabase
        .from('perfiles')
        .select('id,email,full_name,role,created_at')
        .order('created_at', { ascending:false });
      if(error){ tbody.innerHTML=''; msgTabla.innerHTML = `<span class="error">Error: ${error.message}</span>`; return; }

      tbody.innerHTML = '';
      (data||[]).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.email ?? '—'}</td>
          <td>${p.full_name ?? '—'}</td>
          <td>
            <select data-id="${p.id||''}" data-email="${p.email||''}" class="sel-role">
              ${['viewer','operador','supervisor','admin'].map(r => `<option value="${r}" ${p.role===r?'selected':''}>${r}</option>`).join('')}
            </select>
          </td>
          <td class="muted">${p.created_at ? new Date(p.created_at).toLocaleString() : '—'}</td>
          <td class="right">
            <button class="btn secondary btn-del" data-email="${p.email||''}">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Eventos por fila
      tbody.querySelectorAll('.sel-role').forEach(sel=>{
        sel.addEventListener('change', async (e)=>{
          const nv = e.target.value;
          const email = e.target.dataset.email;
          const id = e.target.dataset.id || null;
          const q = id ? { id } : { email };
          const { error } = await supabase.from('perfiles').update({ role:nv }).match(q);
          if(error) alert('Error: '+error.message);
          if(user && (email===user.email)) { // si me cambié a mí mismo, refresco header
            rolUser = nv; rolActual.innerHTML = `<span class="pill">${rolUser}</span>`;
          }
        });
      });

      tbody.querySelectorAll('.btn-del').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const email = btn.dataset.email;
          if(!confirm(`Eliminar perfil de ${email}?`)) return;
          const { error } = await supabase.from('perfiles').delete().eq('email', email);
          if(error) alert('Error: '+error.message);
          await cargarTabla();
        });
      });
    }
  </script>
</body>
</html>