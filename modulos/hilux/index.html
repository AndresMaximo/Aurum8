<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AURUM∞ · Hilux · Checklist 3D</title>

  <link rel="stylesheet" href="/aurum-theme.css" />
  <link rel="stylesheet" href="/Modulos/common/topbar.css" />
  <style>
    .page{max-width:1100px;margin:120px auto 64px;padding:0 16px}
    .panel{background:rgba(8,22,33,.6);border:1px solid rgba(120,255,233,.22);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25),inset 0 0 40px rgba(120,255,233,.06);padding:20px;margin-bottom:24px}
    .panel h2{margin:0 0 8px;color:#b8fff5;text-shadow:0 0 10px rgba(120,255,233,.25);letter-spacing:.04em;font-weight:700}
    label{font-size:.9rem;color:#cfeff0;display:block;margin-bottom:8px}
    input,textarea{width:100%;background:rgba(0,0,0,.35);border:1px solid rgba(120,255,233,.18);color:#e9fffb;padding:10px 12px;border-radius:10px;outline:none}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-block;padding:10px 16px;border-radius:12px;border:1px solid rgba(120,255,233,.25);color:#001f25;background:linear-gradient(135deg,#86ffe9,#18f8c2 55%,#34ffd6);font-weight:700;letter-spacing:.02em;cursor:pointer;transition:transform .12s,filter .12s}
    .btn:hover{transform:translateY(-1px);filter:saturate(1.1)}
    .muted{color:#a6c9cb;font-size:.9rem}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .points{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;margin-top:8px}
    .point{display:flex;gap:10px;align-items:flex-start;background:rgba(120,255,233,.06);border:1px solid rgba(120,255,233,.15);border-radius:12px;padding:10px}
    .point input{width:auto;margin-top:4px}
    .pill{display:inline-block;border:1px solid rgba(120,255,233,.35);border-radius:999px;padding:4px 10px;margin-right:6px;background:rgba(120,255,233,.08);font-size:.8rem}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    thead th{text-align:left;font-size:.85rem;color:#8feee0;padding:12px;background:rgba(120,255,233,.075);border-bottom:1px solid rgba(120,255,233,.15)}
    tbody td{padding:12px;border-bottom:1px solid rgba(120,255,233,.08);color:#e6fffb}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .row-actions .btn{background:transparent;color:#9bf3e7;border-color:rgba(120,255,233,.35);padding:6px 10px}
  </style>
</head>
<body>
  <div id="topbar"></div>

  <main class="page">
    <section class="panel">
      <h2>Nuevo checklist</h2>
      <div class="grid-2">
        <div>
          <label>Vehículo / Unidad</label>
          <input id="vehiculo" placeholder="Ej: Hilux PLACA-123" />
        </div>
        <div>
          <label>Inspector</label>
          <input id="inspector" placeholder="Nombre del inspector" />
        </div>
      </div>

      <div style="margin-top:14px">
        <span class="pill">50 puntos</span>
        <span class="pill">Trazabilidad básica</span>
      </div>

      <div id="points" class="points"></div>

      <div style="margin-top:14px">
        <label>Observaciones</label>
        <textarea id="obs" placeholder="Comentarios generales, hallazgos, acciones..."></textarea>
      </div>

      <div style="margin-top:14px;display:flex;gap:12px;align-items:center">
        <button id="guardar" class="btn">Guardar checklist</button>
        <span id="msg" class="muted"></span>
      </div>
    </section>

    <section class="panel">
      <h2>Historial reciente</h2>
      <div class="muted" style="margin-bottom:8px">Últimos 20 checklists guardados.</div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>Vehículo</th><th>Inspector</th><th>OK</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td class="muted" colspan="5">Cargando…</td></tr></tbody>
        </table>
      </div>
    </section>

    <section id="viewer" class="panel" style="display:none">
      <h2>Detalle</h2>
      <div id="chips" style="margin-bottom:8px"></div>
      <div id="detalle" class="muted">—</div>
    </section>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/aurum.js"></script>
  <script>
    // Topbar
    (async()=>{try{const h=await fetch('/Modulos/common/topbar.html',{cache:'no-store'}).then(r=>r.text());document.getElementById('topbar').innerHTML=h;}catch(e){}})();

    // --- 50 puntos de inspección (puedes renombrar libremente los textos) ---
    const POINTS = [
      "Nivel de aceite motor", "Refrigerante", "Líquido de frenos", "Líquido dirección", "Líquido limpiaparabrisas",
      "Batería – bornes", "Correas visibles", "Fugas visibles", "Filtro de aire", "Filtro de combustible",
      "Radiador – tapas y mangueras", "Manguitos – grietas", "Ventilador – juego", "Caja de fusibles – repuestos", "Luces bajas",
      "Luces altas", "Intermitentes", "Balizas", "Luz de freno", "Luz de retroceso",
      "Neumático delantero izq.", "Neumático delantero der.", "Neumático trasero izq.", "Neumático trasero der.", "Rueda de repuesto",
      "Presión de neumáticos", "Desgaste parejo", "Apriete tuercas", "Frenos – prueba rodado", "Freno de mano",
      "Dirección – juego", "Suspensión – ruidos", "Amortiguadores", "Parabrisas – fisuras", "Limpiaparabrisas – escobillas",
      "Cinturones de seguridad", "Sillas/rieles – fijación", "Bocina", "Espejos", "Puertas – cierre",
      "Extintor – carga", "Botiquín – contenido", "Triángulos", "Chaleco reflectante", "Kit herramientas",
      "Documentación", "GPS/Telemática", "Estado carrocería", "Pintura/Señalética", "Limpieza general"
    ];

    // UI refs
    const $vehiculo = document.getElementById('vehiculo');
    const $inspector = document.getElementById('inspector');
    const $obs = document.getElementById('obs');
    const $points = document.getElementById('points');
    const $guardar = document.getElementById('guardar');
    const $msg = document.getElementById('msg');
    const $tbody = document.getElementById('tbody');
    const $viewer = document.getElementById('viewer');
    const $chips = document.getElementById('chips');
    const $detalle = document.getElementById('detalle');

    const toast = (t)=>{ $msg.textContent=t; setTimeout(()=> $msg.textContent='', 2200); };

    // Render de puntos
    function renderPoints(){
      $points.innerHTML = POINTS.map((txt,i)=>`
        <label class="point">
          <input type="checkbox" id="p${i}">
          <div>${(i+1).toString().padStart(2,'0')}. ${txt}</div>
        </label>
      `).join('');
    }
    renderPoints();

    // Guardar checklist
    $guardar.addEventListener('click', async ()=>{
      const vehiculo = $vehiculo.value.trim();
      if(!vehiculo){ toast('Indica el vehículo'); return; }
      const inspector = $inspector.value.trim();
      const resultados = {};
      POINTS.forEach((_,i)=>{ resultados[i+1] = document.getElementById('p'+i).checked; });
      const payload = {
        vehiculo,
        inspector: inspector || null,
        resultados,
        observaciones: $obs.value.trim() || null
      };
      const { error } = await window.db.from('hilux_checklists').insert(payload);
      if (error) return toast('Error: '+error.message);
      toast('Checklist guardado');
      // Reset básico
      $vehiculo.value=''; $inspector.value=''; $obs.value='';
      POINTS.forEach((_,i)=>{ document.getElementById('p'+i).checked=false; });
      cargarHistorial();
    });

    // Historial
    async function cargarHistorial(){
      const { data, error } = await window.db
        .from('hilux_checklists')
        .select('id,vehiculo,inspector,resultados,created_at')
        .order('created_at',{ascending:false})
        .limit(20);
      if (error) return $tbody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`;
      if (!data?.length) return $tbody.innerHTML = `<tr><td class="muted" colspan="5">Sin registros.</td></tr>`;
      $tbody.innerHTML = data.map(r=>{
        const ok = Object.values(r.resultados||{}).filter(Boolean).length;
        return `
          <tr data-id="${r.id}">
            <td>${new Date(r.created_at).toLocaleString()}</td>
            <td>${r.vehiculo??'—'}</td>
            <td>${r.inspector??'—'}</td>
            <td>${ok}/50</td>
            <td class="row-actions">
              <button class="btn" data-a="ver">Ver</button>
              <button class="btn" data-a="del">Borrar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    $tbody.addEventListener('click', async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const tr = e.target.closest('tr'); const id = tr?.dataset?.id; if(!id) return;
      const act = b.dataset.a;

      if (act==='del'){
        if(!confirm('¿Eliminar checklist?')) return;
        const { error } = await window.db.from('hilux_checklists').delete().eq('id', id);
        if (error) return toast('Error: '+error.message);
        toast('Eliminado'); cargarHistorial();
      }

      if (act==='ver'){
        const { data, error } = await window.db.from('hilux_checklists').select('*').eq('id', id).single();
        if (error) return toast('Error: '+error.message);
        // Render detalle
        $chips.innerHTML =
          `<span class="pill">${data.vehiculo}</span><span class="pill">${data.inspector||'—'}</span><span class="pill">${new Date(data.created_at).toLocaleString()}</span>`;
        const lines = POINTS.map((txt,i)=>{
          const ok = data.resultados?.[i+1] ? '✅' : '✖️';
          return `${(i+1).toString().padStart(2,'0')}. ${ok}  ${txt}`;
        }).join('\n');
        $detalle.textContent = lines + (data.observaciones? `\n\nObservaciones:\n${data.observaciones}`:'');
        $viewer.style.display = 'block';
        window.scrollTo({top:$viewer.offsetTop - 90,behavior:'smooth'});
      }
    });

    cargarHistorial();
  </script>
</body>
</html>
